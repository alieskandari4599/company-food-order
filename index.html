<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🍽️ سفارش غذای شرکت</title>
<style>
  body{margin:0;background:#0f172a;color:#e6edf6;font-family:Tahoma,system-ui;line-height:1.7}
  header{position:sticky;top:0;z-index:10;background:#1e293b;padding:14px;text-align:center;border-bottom:1px solid #334155}
  .container{max-width:1100px;margin:24px auto;padding:0 18px}
  .card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:20px;margin-bottom:18px}
  h2,h3{margin:6px 0 14px}
  input,select,button{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e6edf6;font-size:15px}
  select.placeholder{color:#94a3b8}
  button{cursor:pointer;font-weight:800;background:linear-gradient(180deg,#22c55e,#16a34a);border:none}
  button[disabled]{opacity:.6;cursor:not-allowed;filter:grayscale(40%)}
  button:hover{filter:brightness(1.05)}
  .danger{background:linear-gradient(180deg,#ef4444,#b91c1c)!important}
  .grid-day{display:grid;gap:12px;grid-template-columns:280px 1fr 1fr}
  @media (max-width:800px){.grid-day{grid-template-columns:1fr}}
  .badge{padding:12px;border-radius:12px;font-weight:800;text-align:center;color:#fff;border:1px solid #334155}
  .badge[data-day="شنبه"]{background:#ef4444}
  .badge[data-day="یکشنبه"]{background:#f59e0b}
  .badge[data-day="دوشنبه"]{background:#10b981}
  .badge[data-day="سه‌شنبه"]{background:#3b82f6}
  .badge[data-day="چهارشنبه"]{background:#8b5cf6}
  .badge.off{background:#64748b;text-decoration:line-through}
  .invalid{border-color:#ef4444 !important; box-shadow:0 0 0 2px rgba(239,68,68,.25)}
  .note{font-size:13px;color:#93c5fd;margin-top:6px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #334155;padding:8px;text-align:center;font-size:13px}
  thead{background:#334155}
  .btn-row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  @media (max-width:700px){.btn-row{grid-template-columns:1fr}}
</style>
</head>
<body>

<header>
  <h2>🍽️ سفارش غذای شرکت</h2>
  <div id="whoAmI"></div>
  <div id="menuStatus" class="note">در حال بارگذاری منو…</div>
</header>

<div class="container">
  <!-- ورود -->
  <div class="card" id="loginDiv">
    <h3>ورود</h3>
    <p class="note">کد ملی خود را وارد کنید.  </p>
    <input id="userCode" placeholder="کد ملی" />
    <button onclick="login()">ورود</button>
    <p id="loginMsg" style="color:#f87171"></p>
  </div>

  <!-- انتخاب کاربر -->
  <div class="card" id="orderDiv" style="display:none;">
    <h3>انتخاب غذا و کنارغذا (۸ تا ۲۱ شهریور)</h3>
    <p id="helloText" class="note"></p>
    <div id="holidayBar" class="note" style="display:none"></div>
    <div id="weeklyContainer"></div>

    <div class="btn-row" style="margin-top:12px">
      <button id="submitBtn" onclick="submitOrder()" disabled>ثبت سفارش</button>
      <button class="danger" onclick="logout()">بازگشت</button>
    </div>
    <p id="progressMsg" class="note" style="display:none"></p>
    <p id="orderMsg" style="color:#34d399"></p>
  </div>

  <!-- پنل مدیر -->
  <div class="card" id="adminDiv" style="display:none;">
    <h3>پنل مدیر</h3>
    <div class="note" id="rangeNote">بازه: ۱۴۰۴/۰۶/۰۸ تا ۱۴۰۴/۰۶/۲۱</div>

    <div class="btn-row" style="margin:10px 0">
      <button onclick="loadSheet()">📥 خواندن سفارش‌ها از گوگل‌شیت</button>
      <button class="danger" onclick="logout()">خروج</button>
    </div>

    <div class="btn-row" style="margin:10px 0">
      <button onclick="exportWeekCSVFromSheet()">⬇️ CSV هفتگی</button>
      <button onclick="exportDailyByFloorCSVFromSheet()">⬇️ CSV روزانه به تفکیک طبقه</button>
    </div>

    <table id="ordersTable">
      <thead>
        <tr><th>کد ملی</th><th>نام</th><th>بخش</th><th>تاریخ</th><th>روز</th><th>غذا</th><th>کنارغذا</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ===== لینک‌ها =====
   اگر آدرس‌ها عوض شد فقط این دو تا را تغییر بده */
const SHEET_URL = "https://script.google.com/macros/s/AKfycbwr9nA2c8A6VN9j7oZJgq3oIrUT2Cb_kZcguxZV5m9fzZkgDbbajFPLD_I9xgexe8oLOw/exec";
const MENU_URL  = "https://alieskandari4599.github.io/company-food-order/menu.json";

/* ===== کارکنان (کامل) ===== */
const users = [
 {"code":"1465316159","name":"علی اصغرزاده صادق","section":"طبقه 4"},
 {"code":"0939825902","name":"سید علی میرتونی","section":"طبقه 4"},
 {"code":"0075102110","name":"محسن اشرف اسلامی","section":"طبقه 4"},
 {"code":"1532626142","name":"زهرا محمدی حلمسلوئی","section":"طبقه 4"},
 {"code":"2710033445","name":"مسعود قاسم زاده سیاهکل","section":"طبقه 3"},
 {"code":"1263594301","name":"مهدی نوروزی خزاقی","section":"طبقه 3"},
 {"code":"0010275975","name":"لیلا رسولی درآباد","section":"طبقه 3"},
 {"code":"0014668688","name":"محمدرضا عبدالهی","section":"طبقه 3"},
 {"code":"0051385090","name":"شاهین فاضل مهر","section":"طبقه 3"},
 {"code":"1450551394","name":"فاطمه پارسای","section":"طبقه 3"},
 {"code":"1263591310","name":"مقداد شفقی","section":"طبقه 3"},
 {"code":"0020090641","name":"فاطمه میرزاخانی","section":"طبقه 3"},
 {"code":"0077320980","name":"جواد مرادپور","section":"طبقه 1"},
 {"code":"0082878110","name":"الناز نوروزی","section":"طبقه 2"},
 {"code":"5449975856","name":"ولی اله غنجی فشکی","section":"طبقه 2"},
 {"code":"0013322214","name":"زهرا بابایی","section":"طبقه 2"},
 {"code":"0076209441","name":"محمد پوریانفر","section":"طبقه 2"},
 {"code":"0013227173","name":"امیرحسین صادق نژاد","section":"طبقه 2"},
 {"code":"0014880751","name":"حسام فلاحت پیشه","section":"طبقه 2"},
 {"code":"1360830634","name":"مهرداد صابر قره بابا","section":"طبقه 2"},
 {"code":"4232135855","name":"محمد صیادی سی سخت","section":"طبقه 2"},
 {"code":"2980435430","name":"فائزه باقری پور","section":"طبقه 2"},
 {"code":"1465352864","name":"روشنک محمدیان","section":"طبقه 2"},
 {"code":"0451327926","name":"لیلا احمدی آورزمان","section":"طبقه 3"},
 {"code":"0310669081","name":"مرتضی نیکوئی","section":"طبقه 1"},
 {"code":"0084697377","name":"مرتضی شاه محمدی","section":"طبقه 1"},
 {"code":"4560132534","name":"پدرام عبدالهی","section":"طبقه 1"},
 {"code":"2471739113","name":"عاطفه سرمد","section":"طبقه 1"},
 {"code":"0071114671","name":"عرفانه سادات یزدانشناس","section":"طبقه 1"},
 {"code":"0058084411","name":"یعقوب رحیمی","section":"طبقه 1"},
 {"code":"2050322747","name":"علیرضا شکر اله نیا روشن","section":"طبقه 1"},
 {"code":"0018553771","name":"صدف علی نژاد","section":"طبقه 1"},
 {"code":"2080284665","name":"طه بالایی","section":"طبقه 1"},
 {"code":"0019294638","name":"پگاه کریمی","section":"طبقه 0"},
 {"code":"1742478638","name":"لیلا منیش داوی","section":"طبقه 0"},
 {"code":"4592243331","name":"رضا داورپناه","section":"طبقه 0"},
 {"code":"0059433876","name":"داود دلاوری پارسا","section":"طبقه 0"},
 {"code":"0025204599","name":"علی اسکندری نصفچی","section":"طبقه 3"},
 {"code":"0011911131","name":"محمد صادق رفیع پویا","section":"طبقه 3"},
 {"code":"0682486401","name":"کاوه رجب پور مقدم","section":"طبقه 2"},
 {"code":"0023475919","name":"زهرا فیلسوفیان","section":"طبقه 1"},
 {"code":"5669148134","name":"حقیقت نوروزی","section":"طبقه 2"}
];

const WORK_DAYS = ["شنبه","یکشنبه","دوشنبه","سه‌شنبه","چهارشنبه"];
let menuDays = [];   // از menu.json
let sides = [];      // از menu.json

/* ---------- LOGIN ---------- */
function login(){
  const code = document.getElementById('userCode').value.trim();
  if(code === 'admin'){
    document.getElementById('loginDiv').style.display='none';
    document.getElementById('adminDiv').style.display='block';
    document.getElementById('whoAmI').textContent='مدیر سیستم';
    return;
  }
  const u = users.find(x=>x.code===code);
  if(!u){ document.getElementById('loginMsg').textContent='کد ملی معتبر نیست!'; return; }
  localStorage.setItem('currentUser',u.code);
  localStorage.setItem('currentUserName',u.name);
  localStorage.setItem('currentUserSection',u.section);
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('orderDiv').style.display='block';
  document.getElementById('helloText').textContent=`سلام ${u.name} (${u.section})`;
  document.getElementById('whoAmI').textContent=`${u.name} • ${u.section}`;
  renderWeeklyForm();
}

function logout(){
  document.getElementById('orderDiv').style.display='none';
  document.getElementById('adminDiv').style.display='none';
  document.getElementById('loginDiv').style.display='block';
  document.getElementById('whoAmI').textContent='';
}

/* ---------- HELPERS ---------- */
function workingSlice(){
  return (menuDays||[]).filter(d=>{
    const inRange = d.jdate >= "1404/06/08" && d.jdate <= "1404/06/21";
    return inRange && WORK_DAYS.includes(d.weekday);
  });
}

function updateSubmitEnabled(){
  const btn = document.getElementById('submitBtn');
  const rows = document.querySelectorAll('[data-row="order"]');
  let allOk = true;
  rows.forEach(row=>{
    const selMeal = row.querySelector('select[data-kind="meal"]');
    const selSide = row.querySelector('select[data-kind="side"]');
    if(!selMeal || !selSide) return; // ردیف‌های بدون سِلکت (مثلاً اگر ایجاد نشد) را نادیده بگیر
    const mOk = selMeal.value !== "";
    const sOk = selSide.value !== "";
    selMeal.classList.toggle('invalid', !mOk);
    selSide.classList.toggle('invalid', !sOk);
    allOk = allOk && (mOk && sOk);
  });
  btn.disabled = !allOk;
}

/* ---------- RENDER WEEK (Fix: روزهای تعطیل data-row ندارند) ---------- */
function renderWeeklyForm(){
  const box = document.getElementById('weeklyContainer');
  const holBar = document.getElementById('holidayBar');
  box.innerHTML='';

  const offs = workingSlice().filter(d=>d.off);
  if(offs.length){
    holBar.style.display='block';
    holBar.textContent = "تعطیلی‌ها: " + offs.map(o=>`${o.jdate} (${o.weekday})`).join(' ، ');
  } else { holBar.style.display='none'; }

  const days = workingSlice();
  days.forEach(item=>{
    if(item.off || !item.menu){
      // ❗ اینجا دیگر data-row="order" نداریم تا در اعتبارسنجی شمرده نشود
      box.insertAdjacentHTML('beforeend', `
        <div class="grid-day">
          <div class="badge off" data-day="${item.weekday}">${item.jdate} — ${item.weekday}</div>
          <div style="grid-column:span 2;opacity:.7">تعطیل / بدون منو</div>
        </div>
      `);
      return;
    }
    const m = item.menu; const keys = Object.keys(m); // نوع1، نوع2، نوع3
    box.insertAdjacentHTML('beforeend', `
      <div class="grid-day" data-row="order">
        <div class="badge" data-day="${item.weekday}">${item.jdate} — ${item.weekday}</div>
        <select id="meal_${item.jdate}" class="placeholder" data-kind="meal" onchange="this.classList.remove('placeholder');updateSubmitEnabled()">
          <option value="" selected disabled>— انتخاب غذا —</option>
          ${keys.map(k=>`<option value="${m[k]}">${m[k]} (${k})</option>`).join('')}
        </select>
        <select id="side_${item.jdate}" class="placeholder" data-kind="side" onchange="this.classList.remove('placeholder');updateSubmitEnabled()">
          <option value="" selected disabled>— انتخاب کنارغذا —</option>
          ${sides.map(s=>`<option value="${s}">${s}</option>`).join('')}
        </select>
      </div>
    `);
  });

  updateSubmitEnabled();
}

/* ---------- SUBMIT ---------- */
async function submitOrder(){
  const code = localStorage.getItem('currentUser');
  const name = localStorage.getItem('currentUserName');
  const section = localStorage.getItem('currentUserSection');
  if(!code){ alert('ابتدا وارد شوید.'); return; }

  const slice = workingSlice().filter(d=>!d.off && d.menu);
  const missing = [];
  const rows = [];
  slice.forEach(d=>{
    const meal = document.getElementById(`meal_${d.jdate}`)?.value || "";
    const side = document.getElementById(`side_${d.jdate}`)?.value || "";
    if(!meal || !side) missing.push(`${d.jdate} (${d.weekday})`);
    else rows.push({code,name,section,jdate:d.jdate,weekday:d.weekday,meal,side});
  });

  if(missing.length){
    const first = missing[0];
    document.getElementById('orderMsg').textContent = "";
    const p = document.getElementById('progressMsg');
    p.style.display='block';
    p.textContent = "این موارد انتخاب نشده‌اند: " + missing.join(" ، ");
    document.getElementById(`meal_${first.split(" ")[0]}`)?.scrollIntoView({behavior:'smooth',block:'center'});
    return;
  }

  const btn = document.getElementById('submitBtn');
  const pmsg = document.getElementById('progressMsg');
  btn.disabled = true;
  pmsg.style.display='block';
  pmsg.textContent = "در حال ثبت سفارش‌ها…";

  try{
    const res = await fetch(SHEET_URL, {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(rows)
    });
    const data = await res.json();
    if(data.ok){
      document.getElementById('orderMsg').textContent = `سفارش‌ها ثبت شد ✅ (تعداد: ${rows.length})`;
      pmsg.style.display='none';
    }else{
      document.getElementById('orderMsg').textContent = "خطا در ثبت سفارش‌ها ❌";
      pmsg.style.display='none';
      btn.disabled = false;
    }
  }catch(e){
    document.getElementById('orderMsg').textContent = "عدم دسترسی به سرور سفارش‌ها ❌";
    pmsg.style.display='none';
    btn.disabled = false;
  }
}

/* ---------- ADMIN: load & CSV from sheet ---------- */
async function loadSheet(){
  try{
    const url = `${SHEET_URL}?from=1404/06/08&to=1404/06/21`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data.ok){ alert('خطا در دریافت سفارش‌ها'); return; }
    const rows = data.rows || [];
    const tbody = document.querySelector('#ordersTable tbody');
    tbody.innerHTML='';
    rows.forEach(r=>{
      tbody.insertAdjacentHTML('beforeend',
        `<tr>
          <td>${r.code||''}</td>
          <td>${r.name||''}</td>
          <td>${r.section||''}</td>
          <td>${r.jdate||''}</td>
          <td>${r.weekday||''}</td>
          <td>${r.meal||''}</td>
          <td>${r.side||''}</td>
        </tr>`);
    });
    alert(`تعداد ردیف خوانده‌شده: ${rows.length}`);
  }catch(e){ alert('عدم دسترسی به سرور سفارش‌ها'); }
}

function exportWeekCSVFromSheet(){
  const tbody=document.querySelector('#ordersTable tbody');
  if(!tbody.children.length){ alert('اول «خواندن سفارش‌ها» را بزنید.'); return; }
  let csv="کد ملی,نام,بخش,تاریخ,روز,غذا,کنارغذا\n";
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    const tds=[...tr.children].map(td=>(td.textContent||'').replaceAll(',','،'));
    csv+=tds.join(",")+"\n";
  });
  downloadCSV("\uFEFF"+csv,"orders_1404-06-08_1404-06-21.csv");
}
function exportDailyByFloorCSVFromSheet(){
  const tbody=document.querySelector('#ordersTable tbody');
  if(!tbody.children.length){ alert('اول «خواندن سفارش‌ها» را بزنید.'); return; }
  const rows=[...tbody.querySelectorAll('tr')].map(tr=>{
    const td=tr.children; return {code:td[0].textContent,name:td[1].textContent,section:td[2].textContent,
      jdate:td[3].textContent,weekday:td[4].textContent,meal:td[5].textContent,side:td[6].textContent};
  });
  const dayOrder=["شنبه","یکشنبه","دوشنبه","سه‌شنبه","چهارشنبه"];
  const days=[...new Set(rows.map(r=>r.weekday))].filter(d=>dayOrder.includes(d))
              .sort((a,b)=>dayOrder.indexOf(a)-dayOrder.indexOf(b));
  days.forEach(day=>{
    const floors=[...new Set(rows.map(r=>r.section))];
    let parts=[];
    floors.forEach(f=>{
      let block = `طبقه: ${f}\nکد ملی,نام,${day}\n`;
      rows.filter(r=>r.section===f && r.weekday===day).forEach(r=>{
        const cell=[r.meal,r.side].filter(Boolean).join(" + ");
        block+=`${r.code},${r.name},${cell}\n`;
      });
      parts.push(block);
    });
    downloadCSV("\uFEFF"+parts.join("\n"),`orders_${day}_by_floor.csv`);
  });
}
function downloadCSV(text, filename){
  const blob=new Blob([text],{type:"text/csv;charset=utf-8"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),0);
}

/* ---------- load menu.json ---------- */
async function loadMenu(){
  try{
    const res = await fetch(MENU_URL + "?v=" + Date.now());
    const data = await res.json();
    menuDays = data.days || [];
    sides = (data.sides || ["نوشابه","دوغ","سالاد"]).filter(s=>s!=="ماست"); // ماست حذف
    document.getElementById('menuStatus').textContent = 'منو بارگذاری شد ✅';
  }catch(e){
    document.getElementById('menuStatus').textContent = 'خطا در بارگذاری منو ❌';
  }
}
loadMenu();
</script>
</body>
</html>