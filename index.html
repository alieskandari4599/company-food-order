<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title> Ø³ÙØ§Ø±Ø´ ØºØ°Ø§ÛŒ Ø´Ø±Ú©Øª</title>
<style>
  :root{
    --bg:#0f172a; --card:rgba(255,255,255,.08); --card-border:rgba(255,255,255,.18);
    --text:#e6edf6; --muted:#b6c2d9; --accent:#22c55e; --accent-strong:#16a34a;
    --danger:#ef4444; --ok:#34d399; --shadow:0 10px 30px rgba(0,0,0,.25); --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tahoma,system-ui;background:var(--bg);color:var(--text);line-height:1.7;}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);
    background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(15,23,42,.75));
    border-bottom:1px solid rgba(255,255,255,.08);}
  .nav{max-width:1100px;margin:auto;padding:16px 20px;display:flex;justify-content:space-between;align-items:center}
  .brand{font-weight:800;font-size:20px}
  #whoAmI{color:var(--muted);font-size:14px}
  .container{max-width:1100px;margin:28px auto;padding:0 20px}
  .card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;text-align:center}
  h2{margin:6px 0 16px;font-size:22px}
  .muted{color:var(--muted);font-size:15px}
  .field{margin:14px 0}
  .input,.select,.button{
    width:100%;padding:14px 16px;font-size:16px;border-radius:14px;
    border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.07);
    color:var(--text);outline:none;transition:all .2s}
  .select{appearance:none;text-align:center;font-weight:bold;}
  .button{background:linear-gradient(180deg,var(--accent),var(--accent-strong));border:none;
    cursor:pointer;font-weight:700;transition:transform .15s}
  .button:hover{transform:translateY(-2px);filter:brightness(1.05);}
  .danger{background:linear-gradient(180deg,var(--danger),#b91c1c)!important;}
  .day{display:grid;gap:12px;grid-template-columns:210px 1fr 220px;align-items:center;margin:10px 0}
  @media (max-width:900px){.day{grid-template-columns:1fr}}
  .badge{padding:10px 12px;border-radius:12px;font-weight:800;text-align:center;
    background:rgba(255,255,255,.06);border:1px solid var(--card-border)}
  .holiday{opacity:.6; text-decoration: line-through; filter: grayscale(0.3);}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:14px;overflow:hidden;border-radius:14px}
  thead th{position:sticky;top:0;z-index:1;background:rgba(255,255,255,.08);backdrop-filter:blur(8px)}
  th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px;text-align:center;font-size:14px}
  tbody tr:nth-child(odd){background:rgba(255,255,255,.04)} tbody tr:hover{background:rgba(255,255,255,.07)}
  .row{display:grid;gap:12px}
  .two{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media (max-width:900px){.two{grid-template-columns:1fr}}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--card-border);background:rgba(255,255,255,.06);font-size:12px;margin:3px}
  .hint{font-size:12px;color:#9fb0c9;margin-top:4px}
  .settings{margin-top:10px;border-top:1px dashed rgba(255,255,255,.2);padding-top:10px;text-align:right}
  .settings .grid{display:grid;gap:8px;grid-template-columns:1fr 1fr 1fr}
  @media (max-width:900px){.settings .grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="brand">ğŸ½ï¸ Ø³Ø§Ù…Ø§Ù†Ù‡ Ø³ÙØ§Ø±Ø´ ØºØ°Ø§ÛŒ Ø´Ø±Ú©Øª</div>
    <div id="whoAmI"></div>
  </div>
</header>

<div class="container">
  <!-- ÙˆØ±ÙˆØ¯ -->
  <div class="card" id="loginDiv">
    <h2>ÙˆØ±ÙˆØ¯</h2>
    <p class="muted">Ú©Ø¯ Ù…Ù„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ </p>
    <div class="field">
      <input id="userCode" class="input"  
    </div>
    <button class="button" onclick="login()">ÙˆØ±ÙˆØ¯</button>
    <p id="loginMsg" style="color:#ff6b6b"></p>
  </div>

  <!-- Ø§Ù†ØªØ®Ø§Ø¨ ØºØ°Ø§ -->
  <div class="card" id="orderDiv" style="display:none;">
    <h2>Ø§Ù†ØªØ®Ø§Ø¨ ØºØ°Ø§ (Û¸ ØªØ§ Û²Û± Ø´Ù‡Ø±ÛŒÙˆØ±)</h2>
    <p id="helloText" class="muted"></p>
    <div id="daysContainer"></div>
    <div class="two" style="margin-top:14px">
      <button class="button" onclick="submitOrder()">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
      <button class="button danger" onclick="logout()">Ø®Ø±ÙˆØ¬ / Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>
    <p id="orderMsg" style="color:#34d399"></p>
  </div>

  <!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± -->
  <div class="card" id="adminDiv" style="display:none;">
    <h2>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>

    <div class="two">
      <div>
        <label class="muted">ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ø®Ø´</label>
        <select id="sectionFilter" class="select" onchange="renderOrdersTable()">
          <option value="Ù‡Ù…Ù‡">Ù‡Ù…Ù‡</option>
        </select>
      </div>
      <div class="row">
        <button class="button" onclick="exportDailyByFloor()">ğŸ“¥ Ø§Ú©Ø³Ù„ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø·Ø¨Ù‚Ù‡</button>
      </div>
    </div>

    <div id="legend" style="text-align:right;margin-top:10px"></div>

    <table id="ordersTable">
      <thead>
        <tr>
          <th>Ú©Ø¯ Ù…Ù„ÛŒ</th><th>Ù†Ø§Ù…</th><th>Ø¨Ø®Ø´</th>
          <th>ØªØ§Ø±ÛŒØ®</th><th>Ø³ÙØ§Ø±Ø´</th><th>Ú©Ù†Ø§Ø± ØºØ°Ø§</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="settings">
      <h3 style="margin:0 0 8px">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ (ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ±)</h3>
      <div class="grid">
        <input id="ghOwner" class="input" placeholder="Owner (Ù…Ø«Ù„Ø§Ù‹: alieskandari4599)" />
        <input id="ghRepo" class="input" placeholder="Repo (Ù…Ø«Ù„Ø§Ù‹: company-food-order)" />
        <input id="ghToken" class="input" placeholder="Token (Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨)" />
      </div>
      <div class="hint">Token Ø±Ø§ Ø§Ø² Settings â†’ Developer settings â†’ Tokens (classic) Ø¨Ø³Ø§Ø²Ø› Ø¯Ø³ØªØ±Ø³ÛŒ <b>public_repo</b> (ÛŒØ§ repo) Ø¨Ø¯Ù‡.</div>
      <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
        <button class="button" onclick="saveGhConfig()">Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
        <button class="button danger" onclick="clearGhConfig()">Ø­Ø°Ù ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="button danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</div>

<script>
/* ------------------ Ú©Ø§Ø±Ú©Ù†Ø§Ù† ------------------ */
const users = [
  {"code":"1465316159","name":"Ø¹Ù„ÛŒ Ø§ØµØºØ±Ø²Ø§Ø¯Ù‡ ØµØ§Ø¯Ù‚","section":"Ø·Ø¨Ù‚Ù‡ 4"},
  {"code":"0939825902","name":"Ø³ÛŒØ¯ Ø¹Ù„ÛŒ Ù…ÛŒØ±ØªÙˆÙ†ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 4"},
  {"code":"0075102110","name":"Ù…Ø­Ø³Ù† Ø§Ø´Ø±Ù Ø§Ø³Ù„Ø§Ù…ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 4"},
  {"code":"1532626142","name":"Ø²Ù‡Ø±Ø§ Ù…Ø­Ù…Ø¯ÛŒ Ø­Ù„Ù…Ø³Ù„ÙˆØ¦ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 4"},
  {"code":"2710033445","name":"Ù…Ø³Ø¹ÙˆØ¯ Ù‚Ø§Ø³Ù… Ø²Ø§Ø¯Ù‡ Ø³ÛŒØ§Ù‡Ú©Ù„","section":"Ø·Ø¨Ù‚Ù‡ 3"},
  {"code":"1263594301","name":"Ù…Ù‡Ø¯ÛŒ Ù†ÙˆØ±ÙˆØ²ÛŒ Ø®Ø²Ø§Ù‚ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
  {"code":"0010275975","name":"Ù„ÛŒÙ„Ø§ Ø±Ø³ÙˆÙ„ÛŒ Ø¯Ø±Ø¢Ø¨Ø§Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 3"},
  {"code":"0014668688","name":"Ù…Ø­Ù…Ø¯Ø±Ø¶Ø§ Ø¹Ø¨Ø¯Ø§Ù„Ù‡ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
  {"code":"0051385090","name":"Ø´Ø§Ù‡ÛŒÙ† ÙØ§Ø¶Ù„ Ù…Ù‡Ø±","section":"Ø·Ø¨Ù‚Ù‡ 3"},
  {"code":"1450551394","name":"ÙØ§Ø·Ù…Ù‡ Ù¾Ø§Ø±Ø³Ø§ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
  {"code":"1263591310","name":"Ù…Ù‚Ø¯Ø§Ø¯ Ø´ÙÙ‚ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
  {"code":"0020090641","name":"ÙØ§Ø·Ù…Ù‡ Ù…ÛŒØ±Ø²Ø§Ø®Ø§Ù†ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
  {"code":"0077320980","name":"Ø¬ÙˆØ§Ø¯ Ù…Ø±Ø§Ø¯Ù¾ÙˆØ±","section":"Ø·Ø¨Ù‚Ù‡ 1"},
  {"code":"0082878110","name":"Ø§Ù„Ù†Ø§Ø² Ù†ÙˆØ±ÙˆØ²ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"},
  {"code":"5449975856","name":"ÙˆÙ„ÛŒ Ø§Ù„Ù‡ ØºÙ†Ø¬ÛŒ ÙØ´Ú©ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"},
  {"code":"0013322214","name":"Ø²Ù‡Ø±Ø§ Ø¨Ø§Ø¨Ø§ÛŒÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"},
  {"code":"0076209441","name":"Ù…Ø­Ù…Ø¯ Ù¾ÙˆØ±ÛŒØ§Ù†ÙØ±","section":"Ø·Ø¨Ù‚Ù‡ 2"},
  {"code":"0013227173","name":"Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† ØµØ§Ø¯Ù‚ Ù†Ú˜Ø§Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 2"},
  {"code":"0014880751","name":"Ø­Ø³Ø§Ù… ÙÙ„Ø§Ø­Øª Ù¾ÛŒØ´Ù‡","section":"Ø·Ø¨Ù‚Ù‡ 2"},
  {"code":"1360830634","name":"Ù…Ù‡Ø±Ø¯Ø§Ø¯ ØµØ§Ø¨Ø± Ù‚Ø±Ù‡ Ø¨Ø§Ø¨Ø§","section":"Ø·Ø¨Ù‚Ù‡ 2"},
  {"code":"4232135855","name":"Ù…Ø­Ù…Ø¯ ØµÛŒØ§Ø¯ÛŒ Ø³ÛŒ Ø³Ø®Øª","section":"Ø·Ø¨Ù‚Ù‡ 2"},
  {"code":"2980435430","name":"ÙØ§Ø¦Ø²Ù‡ Ø¨Ø§Ù‚Ø±ÛŒ Ù¾ÙˆØ±","section":"Ø·Ø¨Ù‚Ù‡ 2"},
  {"code":"1465352864","name":"Ø±ÙˆØ´Ù†Ú© Ù…Ø­Ù…Ø¯ÛŒØ§Ù†","section":"Ø·Ø¨Ù‚Ù‡ 2"},
  {"code":"0451327926","name":"Ù„ÛŒÙ„Ø§ Ø§Ø­Ù…Ø¯ÛŒ Ø¢ÙˆØ±Ø²Ù…Ø§Ù†","section":"Ø·Ø¨Ù‚Ù‡ 3"},
  {"code":"0310669081","name":"Ù…Ø±ØªØ¶ÛŒ Ù†ÛŒÚ©ÙˆØ¦ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
  {"code":"0084697377","name":"Ù…Ø±ØªØ¶ÛŒ Ø´Ø§Ù‡ Ù…Ø­Ù…Ø¯ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
  {"code":"4560132534","name":"Ù¾Ø¯Ø±Ø§Ù… Ø¹Ø¨Ø¯Ø§Ù„Ù‡ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
  {"code":"2471739113","name":"Ø¹Ø§Ø·ÙÙ‡ Ø³Ø±Ù…Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 1"},
  {"code":"0071114671","name":"Ø¹Ø±ÙØ§Ù†Ù‡ Ø³Ø§Ø¯Ø§Øª ÛŒØ²Ø¯Ø§Ù†Ø´Ù†Ø§Ø³","section":"Ø·Ø¨Ù‚Ù‡ 1"},
  {"code":"0058084411","name":"ÛŒØ¹Ù‚ÙˆØ¨ Ø±Ø­ÛŒÙ…ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
  {"code":"2050322747","name":"Ø¹Ù„ÛŒØ±Ø¶Ø§ Ø´Ú©Ø± Ø§Ù„Ù‡ Ù†ÛŒØ§ Ø±ÙˆØ´Ù†","section":"Ø·Ø¨Ù‚Ù‡ 1"},
  {"code":"0018553771","name":"ØµØ¯Ù Ø¹Ù„ÛŒ Ù†Ú˜Ø§Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 1"},
  {"code":"2080284665","name":"Ø·Ù‡ Ø¨Ø§Ù„Ø§ÛŒÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
  {"code":"0019294638","name":"Ù¾Ú¯Ø§Ù‡ Ú©Ø±ÛŒÙ…ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 0"},
  {"code":"1742478638","name":"Ù„ÛŒÙ„Ø§ Ù…Ù†ÛŒØ´ Ø¯Ø§ÙˆÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 0"},
  {"code":"4592243331","name":"Ø±Ø¶Ø§ Ø¯Ø§ÙˆØ±Ù¾Ù†Ø§Ù‡","section":"Ø·Ø¨Ù‚Ù‡ 0"},
  {"code":"0059433876","name":"Ø¯Ø§ÙˆØ¯ Ø¯Ù„Ø§ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ø§","section":"Ø·Ø¨Ù‚Ù‡ 0"},
  {"code":"0025204599","name":"Ø¹Ù„ÛŒ Ø§Ø³Ú©Ù†Ø¯Ø±ÛŒ Ù†ØµÙÚ†ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
  {"code":"0011911131","name":"Ù…Ø­Ù…Ø¯ ØµØ§Ø¯Ù‚ Ø±ÙÛŒØ¹ Ù¾ÙˆÛŒØ§","section":"Ø·Ø¨Ù‚Ù‡ 3"},
  {"code":"0682486401","name":"Ú©Ø§ÙˆÙ‡ Ø±Ø¬Ø¨ Ù¾ÙˆØ± Ù…Ù‚Ø¯Ù…","section":"Ø·Ø¨Ù‚Ù‡ 2"},
  {"code":"0023475919","name":"Ø²Ù‡Ø±Ø§ ÙÛŒÙ„Ø³ÙˆÙÛŒØ§Ù†","section":"Ø·Ø¨Ù‚Ù‡ 1"},
  {"code":"5669148134","name":"Ø­Ù‚ÛŒÙ‚Øª Ù†ÙˆØ±ÙˆØ²ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"}
];

const SIDE_ITEMS = ["Ù†ÙˆØ´Ø§Ø¨Ù‡","Ø¯ÙˆØº","Ø³Ø§Ù„Ø§Ø¯ ÙØµÙ„"];
const ORDERS_FILENAME = "orders.json";
const MENU_FILENAME   = "menu.json";
const LS_KEY_CFG = "gh_cfg_v1";  // {owner, repo, token}
const LS_KEY_ORD = "orders_cache_v1"; // fallback Ù„ÙˆÚ©Ø§Ù„ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§

let MENU = {};   // Ø§Ø² menu.json
let GH = {owner:"", repo:"", token:""}; // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ (Ù…Ø¯ÛŒØ±)

/* ------------- Ø§Ø¨Ø²Ø§Ø± ------------- */
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const b64 = s => btoa(unescape(encodeURIComponent(s)));
const unb64 = s => decodeURIComponent(escape(atob(s)));
function cssId(s){ return s.replace(/\s+/g,"_"); }
function parseJSON(s, fallback){ try{return JSON.parse(s);}catch{ return fallback; } }

/* ------------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ (Ù…Ø¯ÛŒØ±) ------------- */
function loadGhConfig(){
  GH = parseJSON(localStorage.getItem(LS_KEY_CFG), {owner:"",repo:"",token:""});
  document.getElementById("ghOwner").value = GH.owner||"";
  document.getElementById("ghRepo").value  = GH.repo||"";
  document.getElementById("ghToken").value = GH.token||"";
}
function saveGhConfig(){
  GH.owner = document.getElementById("ghOwner").value.trim();
  GH.repo  = document.getElementById("ghRepo").value.trim();
  GH.token = document.getElementById("ghToken").value.trim();
  localStorage.setItem(LS_KEY_CFG, JSON.stringify(GH));
  alert("ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.");
}
function clearGhConfig(){
  localStorage.removeItem(LS_KEY_CFG);
  loadGhConfig();
  alert("ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§Ú© Ø´Ø¯.");
}

/* ------------- Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø®Ø§Ù… Ø§Ø² Ø±ÛŒÙ¾Ùˆ (raw) ------------- */
async function fetchRaw(path){
  const url = `https://raw.githubusercontent.com/${GH.owner || location.hostname.split('.')[0]}/${GH.repo || location.pathname.split('/')[1] || ''}/main/${path}`;
  // Ø§Ú¯Ø± owner/repo ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§Ø² Ø¢Ø¯Ø±Ø³ ÙØ¹Ù„ÛŒ Ø­Ø¯Ø³ Ø¨Ø²Ù†ÛŒÙ…
  try{
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    return await res.text();
  }catch(e){
    // Ø­Ø§Ù„Øª fallback: Ø§Ú¯Ø± ØµÙØ­Ù‡ Ø§Ø² gh-pages Ø§ÙˆÙ…Ø¯Ù‡ Ùˆ Ø¢Ø¯Ø±Ø³ Ø±Ùˆ Ù†ØªÙˆÙ†Ø³Øª Ø­Ø¯Ø³ Ø¨Ø²Ù†Ù‡ØŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² Ø±ÛŒØ´Ù‡ Ù‡Ù… Ø§Ù…ØªØ­Ø§Ù† Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    const local = await fetch(path, {cache:"no-store"}).then(r=>r.ok?r.text():null).catch(()=>null);
    if(local!==null) return local;
    throw e;
  }
}

/* ------------- GitHub API: Ú¯Ø±ÙØªÙ† SHA Ùˆ Ø¢Ù¾Ø¯ÛŒØª ÙØ§ÛŒÙ„ ------------- */
async function getFileSha(path){
  const url = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}`;
  const res = await fetch(url, {
    headers: {"Authorization": `token ${GH.token}`}
  });
  if(res.status===404) return null; // ÙØ§ÛŒÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
  if(!res.ok) throw new Error("getFileSha: "+res.status);
  const js = await res.json();
  return js.sha;
}

async function putFile(path, contentStr, message){
  if(!GH.owner||!GH.repo||!GH.token){ throw new Error("ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª."); }
  const sha = await getFileSha(path);
  const url = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}`;
  const body = {
    message: message || `update ${path}`,
    content: b64(contentStr),
    sha: sha || undefined
  };
  const res = await fetch(url, {
    method:"PUT",
    headers:{
      "Authorization": `token ${GH.token}`,
      "Content-Type":"application/json"
    },
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error("putFile: "+res.status+" "+t);
  }
  return await res.json();
}

/* ------------- ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬ ------------- */
function login(){
  const code = document.getElementById("userCode").value.trim();
  if(code==="admin"){
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("adminDiv").style.display="block";
    document.getElementById("whoAmI").textContent = "Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…";
    loadGhConfig();
    populateSectionFilter();
    renderLegend();
    renderOrdersTable();
    return;
  }
  const u = users.find(x=>x.code===code);
  if(!u){ document.getElementById("loginMsg").textContent="Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª!"; return; }
  localStorage.setItem("currentUser", u.code);
  localStorage.setItem("currentUserName", u.name);
  localStorage.setItem("currentUserSection", u.section);
  document.getElementById("loginDiv").style.display="none";
  document.getElementById("orderDiv").style.display="block";
  document.getElementById("whoAmI").textContent = `${u.name} â€¢ ${u.section}`;
  document.getElementById("helloText").textContent = `Ø³Ù„Ø§Ù… ${u.name}! Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±ÙˆØ² ÛŒÚ© Ø¢ÛŒØªÙ… Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.`;
  renderOrderForm();
}

function logout(){
  document.getElementById("loginDiv").style.display="block";
  document.getElementById("orderDiv").style.display="none";
  document.getElementById("adminDiv").style.display="none";
  document.getElementById("whoAmI").textContent = "";
}

/* ------------- Ù…Ù†Ùˆ Ùˆ ÙØ±Ù… Ø³ÙØ§Ø±Ø´ ------------- */
async function loadMenu(){
  try{
    // Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ù†Ùˆ Ø§Ø² Ø±ÛŒØ´Ù‡ Ø±ÛŒÙ¾Ùˆ (menu.json Ú©Ù†Ø§Ø± index.html)
    const t = await fetchRaw(MENU_FILENAME);
    MENU = JSON.parse(t);
  }catch(e){
    alert("menu.json Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ ÛŒØ§ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
    MENU = {};
  }
}

function renderLegend(){
  const lg = document.getElementById("legend");
  lg.innerHTML = Object.keys(MENU).map(d=>{
    const itm = MENU[d];
    if (itm.ØªØ¹Ø·ÛŒÙ„) return `<span class="pill holiday">${d} (ØªØ¹Ø·ÛŒÙ„)</span>`;
    return `<span class="pill">${d}</span>`;
  }).join("");
}

function renderOrderForm(){
  const c = document.getElementById("daysContainer");
  c.innerHTML = "";

  Object.keys(MENU).forEach(dateLabel=>{
    const item = MENU[dateLabel];

    if(item.ØªØ¹Ø·ÛŒÙ„){
      const wrap = document.createElement("div");
      wrap.className = "day holiday";
      wrap.innerHTML = `
        <div class="badge">${dateLabel}</div>
        <div style="text-align:right">ØªØ¹Ø·ÛŒÙ„</div>
        <div></div>
      `;
      c.appendChild(wrap);
      return;
    }

    const wrap = document.createElement("div");
    wrap.className = "day";
    wrap.innerHTML = `
      <div class="badge">${dateLabel}</div>
      <select id="meal_${cssId(dateLabel)}" class="select">
        <option value="${item.Ø®ÙˆØ±Ø§Ú©}">${item.Ø®ÙˆØ±Ø§Ú©} (Ø®ÙˆØ±Ø§Ú©)</option>
        <option value="${item.Ú©Ø¨Ø§Ø¨ÛŒ}">${item.Ú©Ø¨Ø§Ø¨ÛŒ} (Ú©Ø¨Ø§Ø¨ÛŒ)</option>
        <option value="${item.Ø®ÙˆØ±Ø´ØªÛŒ}">${item.Ø®ÙˆØ±Ø´ØªÛŒ} (Ø®ÙˆØ±Ø´ØªÛŒ)</option>
      </select>
      <select id="side_${cssId(dateLabel)}" class="select">
        ${["Ù†ÙˆØ´Ø§Ø¨Ù‡","Ø¯ÙˆØº","Ø³Ø§Ù„Ø§Ø¯ ÙØµÙ„"].map(s=>`<option value="${s}">${s}</option>`).join("")}
      </select>
    `;
    c.appendChild(wrap);
  });
}

/* ------------- Ø®ÙˆØ§Ù†Ø¯Ù†/Ù†ÙˆØ´ØªÙ† Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ Ø±ÙˆÛŒ Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ ------------- */
// orders.json Ø³Ø§Ø®ØªØ§Ø±:
/// {
///   "1465316159": { "section":"Ø·Ø¨Ù‚Ù‡ 4", "items": { "Û¸ Ø´Ù‡Ø±ÛŒÙˆØ±": {"meal":"...","side":"..."}, ... } },
///   "0939825902": { ... }
/// }
async function readOrdersCentral(){
  try{
    const t = await fetchRaw(ORDERS_FILENAME);
    return JSON.parse(t||"{}");
  }catch(e){
    return {};
  }
}

async function writeOrdersCentral(updatedObj){
  // Ù†ÛŒØ§Ø² Ø¨Ù‡ GH.owner/repo/token Ø¯Ø§Ø±Ø¯
  const payload = JSON.stringify(updatedObj, null, 2);
  await putFile(ORDERS_FILENAME, payload, "Update orders.json");
}

async function submitOrder(){
  const code = localStorage.getItem("currentUser");
  const section = localStorage.getItem("currentUserSection") || "";

  // 1) Ø®ÙˆØ§Ù†Ø¯Ù† orders.json ÙØ¹Ù„ÛŒ Ø§Ø² Ø±ÛŒÙ¾Ùˆ
  let orders = await readOrdersCentral();

  // 2) Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ú©Ø§Ø±Ø¨Ø±
  if(!orders[code]) orders[code] = { section, items:{} };
  Object.keys(MENU).forEach(dateLabel=>{
    const itm = MENU[dateLabel];
    if(itm.ØªØ¹Ø·ÛŒÙ„) return;
    const meal = document.getElementById("meal_"+cssId(dateLabel)).value;
    const side = document.getElementById("side_"+cssId(dateLabel)).value;
    orders[code].items[dateLabel] = { meal, side };
  });

  // 3) Ù†ÙˆØ´ØªÙ† Ø±ÙˆÛŒ Ø±ÛŒÙ¾Ùˆ (Ú©Ø§Ù…ÛŒØª)
  try{
    await writeOrdersCentral(orders);
    document.getElementById("orderMsg").textContent = "Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ âœ…";
    localStorage.setItem(LS_KEY_ORD, JSON.stringify(orders)); // Ú©Ø´ Ù…Ø­Ù„ÛŒ
  }catch(e){
    // Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø§Ø´Øª (Ù…Ø«Ù„Ø§Ù‹ ØªÙˆÚ©Ù† Ø®Ø§Ù„ÛŒ)ØŒ ØªÙˆ Ù„ÙˆÚ©Ø§Ù„ Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒÙ… Ùˆ Ø§Ø·Ù„Ø§Ø¹ Ø¨Ø¯ÛŒÙ…
    localStorage.setItem(LS_KEY_ORD, JSON.stringify(orders));
    alert("Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø±Ú©Ø²ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ (Owner/Repo/Token) Ø±Ø§ Ø¯Ø± Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± Ú©Ø§Ù…Ù„ Ú©Ù†.");
  }
}

/* ------------- Ù…Ø¯ÛŒØ±: Ø¬Ø¯ÙˆÙ„ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ + Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ Ø±ÙˆØ²Ø§Ù†Ù‡ ------------- */
function populateSectionFilter(){
  const select = document.getElementById("sectionFilter");
  const sections = [...new Set(users.map(u=>u.section))];
  sections.forEach(sec=>{
    const op = document.createElement("option");
    op.value = sec; op.textContent = sec;
    select.appendChild(op);
  });
}

async function renderOrdersTable(){
  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = "";
  const filter = document.getElementById("sectionFilter").value;

  // ØªØ±Ø¬ÛŒØ­: Ø§Ø² Ù…Ø±Ú©Ø² Ø¨Ø®ÙˆØ§Ù†
  let orders = await readOrdersCentral();
  if(!Object.keys(orders).length){
    // Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø² Ú©Ø´ Ù…Ø­Ù„ÛŒ
    orders = parseJSON(localStorage.getItem(LS_KEY_ORD), {});
  }

  users.forEach(u=>{
    const rec = orders[u.code];
    if(!rec) return;
    if(filter!=="Ù‡Ù…Ù‡" && (rec.section||u.section)!==filter) return;

    Object.keys(rec.items||{}).forEach(date=>{
      const v = rec.items[date];
      tbody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${u.code}</td><td>${u.name}</td><td>${rec.section||u.section||""}</td>
          <td>${date}</td><td>${v.meal}</td><td>${v.side||""}</td>
        </tr>`
      );
    });
  });
}

async function exportDailyByFloor(){
  // Ø§Ø² Ù…Ø¯ÛŒØ± ØªØ§Ø±ÛŒØ® Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
  const dateLabel = prompt("ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø«Ù„ menu.json ÙˆØ§Ø±Ø¯ Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹: Û±Û¸ Ø´Ù‡Ø±ÛŒÙˆØ±):");
  if(!dateLabel || !MENU[dateLabel]){ alert("ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø± ÛŒØ§ Ø¯Ø± Ù…Ù†Ùˆ Ù†ÛŒØ³Øª."); return; }

  // Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ø±Ú©Ø²ÛŒ
  let orders = await readOrdersCentral();
  if(!Object.keys(orders).length){
    orders = parseJSON(localStorage.getItem(LS_KEY_ORD), {});
  }

  const floors = [...new Set(users.map(u=>u.section))].sort();
  let csv = "Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø·Ø¨Ù‚Ù‡\n";
  floors.forEach(floor=>{
    csv += `\n${floor}\nÚ©Ø¯ Ù…Ù„ÛŒ,Ù†Ø§Ù…,Ø¨Ø®Ø´,ØªØ§Ø±ÛŒØ®,Ø³ÙØ§Ø±Ø´,Ú©Ù†Ø§Ø± ØºØ°Ø§\n`;
    users.forEach(u=>{
      if(u.section!==floor) return;
      const rec = orders[u.code];
      const cell = rec?.items?.[dateLabel];
      if(cell){
        csv += `${u.code},${u.name},${floor},${dateLabel},${cell.meal},${cell.side||""}\n`;
      }
    });
  });

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `orders_daily_${dateLabel.replace(/\s+/g,'_')}.csv`;
  a.click();
}

/* ------------- Ø¨ÙˆØª ------------- */
(async function boot(){
  // Ø§Ú¯Ø± Ù…Ø¯ÛŒØ± Ù‚Ø¨Ù„Ø§Ù‹ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ø±Ø¯Ù‡ØŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†
  loadGhConfig();
  // Ù…Ù†Ùˆ Ø±Ø§ Ø¨Ø®ÙˆØ§Ù†
  try{
    MENU = JSON.parse(await fetchRaw(MENU_FILENAME));
  }catch(e){
    MENU = {};
    alert("menu.json ÛŒØ§ÙØª Ù†Ø´Ø¯.");
  }
  renderLegend();
})();
</script>
</body>
</html>
