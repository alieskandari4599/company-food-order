<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ½ï¸ Ø³ÙØ§Ø±Ø´ ØºØ°Ø§ÛŒ Ø´Ø±Ú©Øª</title>
<style>
  body{margin:0;background:#0f172a;color:#e6edf6;font-family:Tahoma,system-ui;line-height:1.7}
  header{position:sticky;top:0;z-index:10;background:#1e293b;padding:14px;text-align:center;border-bottom:1px solid #334155}
  .container{max-width:1100px;margin:24px auto;padding:0 18px}
  .card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:20px;margin-bottom:18px}
  h2,h3{margin:6px 0 14px}
  input,select,button{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e6edf6;font-size:15px}
  select.placeholder{color:#94a3b8}
  button{cursor:pointer;font-weight:800;background:linear-gradient(180deg,#22c55e,#16a34a);border:none}
  button[disabled]{opacity:.6;cursor:not-allowed;filter:grayscale(40%)}
  button:hover{filter:brightness(1.05)}
  .danger{background:linear-gradient(180deg,#ef4444,#b91c1c)!important}
  .grid-day{display:grid;gap:12px;grid-template-columns:280px 1fr 1fr}
  @media (max-width:800px){.grid-day{grid-template-columns:1fr}}
  .badge{padding:12px;border-radius:12px;font-weight:800;text-align:center;color:#fff;border:1px solid #334155}
  .badge[data-day="Ø´Ù†Ø¨Ù‡"]{background:#ef4444}
  .badge[data-day="ÛŒÚ©Ø´Ù†Ø¨Ù‡"]{background:#f59e0b}
  .badge[data-day="Ø¯ÙˆØ´Ù†Ø¨Ù‡"]{background:#10b981}
  .badge[data-day="Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡"]{background:#3b82f6}
  .badge[data-day="Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡"]{background:#8b5cf6}
  .badge.off{background:#64748b;text-decoration:line-through}
  .invalid{border-color:#ef4444 !important; box-shadow:0 0 0 2px rgba(239,68,68,.25)}
  .note{font-size:13px;color:#93c5fd;margin-top:6px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #334155;padding:8px;text-align:center;font-size:13px}
  thead{background:#334155}
  .btn-row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  @media (max-width:700px){.btn-row{grid-template-columns:1fr}}
</style>
</head>
<body>

<header>
  <h2>ğŸ½ï¸ Ø³ÙØ§Ø±Ø´ ØºØ°Ø§ÛŒ Ø´Ø±Ú©Øª</h2>
  <div id="whoAmI"></div>
  <div id="menuStatus" class="note">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ù†Ùˆâ€¦</div>
</header>

<div class="container">
  <!-- ÙˆØ±ÙˆØ¯ -->
  <div class="card" id="loginDiv">
    <h3>ÙˆØ±ÙˆØ¯</h3>
    <p class="note">Ú©Ø¯ Ù…Ù„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.  </p>
    <input id="userCode" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ" />
    <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
    <p id="loginMsg" style="color:#f87171"></p>
  </div>

  <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± -->
  <div class="card" id="orderDiv" style="display:none;">
    <h3>Ø§Ù†ØªØ®Ø§Ø¨ ØºØ°Ø§ Ùˆ Ú©Ù†Ø§Ø±ØºØ°Ø§ (Û¸ ØªØ§ Û²Û± Ø´Ù‡Ø±ÛŒÙˆØ±)</h3>
    <p id="helloText" class="note"></p>
    <div id="holidayBar" class="note" style="display:none"></div>
    <div id="weeklyContainer"></div>

    <div class="btn-row" style="margin-top:12px">
      <button id="submitBtn" onclick="submitOrder()" disabled>Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
      <button class="danger" onclick="logout()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>
    <p id="progressMsg" class="note" style="display:none"></p>
    <p id="orderMsg" style="color:#34d399"></p>
  </div>

  <!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± -->
  <div class="card" id="adminDiv" style="display:none;">
    <h3>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±</h3>
    <div class="note" id="rangeNote">Ø¨Ø§Ø²Ù‡: Û±Û´Û°Û´/Û°Û¶/Û°Û¸ ØªØ§ Û±Û´Û°Û´/Û°Û¶/Û²Û±</div>

    <div class="btn-row" style="margin:10px 0">
      <button onclick="loadSheet()">ğŸ“¥ Ø®ÙˆØ§Ù†Ø¯Ù† Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ Ø§Ø² Ú¯ÙˆÚ¯Ù„â€ŒØ´ÛŒØª</button>
      <button class="danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="btn-row" style="margin:10px 0">
      <button onclick="exportWeekCSVFromSheet()">â¬‡ï¸ CSV Ù‡ÙØªÚ¯ÛŒ</button>
      <button onclick="exportDailyByFloorCSVFromSheet()">â¬‡ï¸ CSV Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø·Ø¨Ù‚Ù‡</button>
    </div>

    <table id="ordersTable">
      <thead>
        <tr><th>Ú©Ø¯ Ù…Ù„ÛŒ</th><th>Ù†Ø§Ù…</th><th>Ø¨Ø®Ø´</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø±ÙˆØ²</th><th>ØºØ°Ø§</th><th>Ú©Ù†Ø§Ø±ØºØ°Ø§</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ===== Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ =====
   Ø§Ú¯Ø± Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø¹ÙˆØ¶ Ø´Ø¯ ÙÙ‚Ø· Ø§ÛŒÙ† Ø¯Ùˆ ØªØ§ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡ */
const SHEET_URL = "https://script.google.com/macros/s/AKfycbwr9nA2c8A6VN9j7oZJgq3oIrUT2Cb_kZcguxZV5m9fzZkgDbbajFPLD_I9xgexe8oLOw/exec";
const MENU_URL  = "https://alieskandari4599.github.io/company-food-order/menu.json";

/* ===== Ú©Ø§Ø±Ú©Ù†Ø§Ù† (Ú©Ø§Ù…Ù„) ===== */
const users = [
 {"code":"1465316159","name":"Ø¹Ù„ÛŒ Ø§ØµØºØ±Ø²Ø§Ø¯Ù‡ ØµØ§Ø¯Ù‚","section":"Ø·Ø¨Ù‚Ù‡ 4"},
 {"code":"0939825902","name":"Ø³ÛŒØ¯ Ø¹Ù„ÛŒ Ù…ÛŒØ±ØªÙˆÙ†ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 4"},
 {"code":"0075102110","name":"Ù…Ø­Ø³Ù† Ø§Ø´Ø±Ù Ø§Ø³Ù„Ø§Ù…ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 4"},
 {"code":"1532626142","name":"Ø²Ù‡Ø±Ø§ Ù…Ø­Ù…Ø¯ÛŒ Ø­Ù„Ù…Ø³Ù„ÙˆØ¦ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 4"},
 {"code":"2710033445","name":"Ù…Ø³Ø¹ÙˆØ¯ Ù‚Ø§Ø³Ù… Ø²Ø§Ø¯Ù‡ Ø³ÛŒØ§Ù‡Ú©Ù„","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"1263594301","name":"Ù…Ù‡Ø¯ÛŒ Ù†ÙˆØ±ÙˆØ²ÛŒ Ø®Ø²Ø§Ù‚ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0010275975","name":"Ù„ÛŒÙ„Ø§ Ø±Ø³ÙˆÙ„ÛŒ Ø¯Ø±Ø¢Ø¨Ø§Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0014668688","name":"Ù…Ø­Ù…Ø¯Ø±Ø¶Ø§ Ø¹Ø¨Ø¯Ø§Ù„Ù‡ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0051385090","name":"Ø´Ø§Ù‡ÛŒÙ† ÙØ§Ø¶Ù„ Ù…Ù‡Ø±","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"1450551394","name":"ÙØ§Ø·Ù…Ù‡ Ù¾Ø§Ø±Ø³Ø§ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"1263591310","name":"Ù…Ù‚Ø¯Ø§Ø¯ Ø´ÙÙ‚ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0020090641","name":"ÙØ§Ø·Ù…Ù‡ Ù…ÛŒØ±Ø²Ø§Ø®Ø§Ù†ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0077320980","name":"Ø¬ÙˆØ§Ø¯ Ù…Ø±Ø§Ø¯Ù¾ÙˆØ±","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0082878110","name":"Ø§Ù„Ù†Ø§Ø² Ù†ÙˆØ±ÙˆØ²ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"5449975856","name":"ÙˆÙ„ÛŒ Ø§Ù„Ù‡ ØºÙ†Ø¬ÛŒ ÙØ´Ú©ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0013322214","name":"Ø²Ù‡Ø±Ø§ Ø¨Ø§Ø¨Ø§ÛŒÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0076209441","name":"Ù…Ø­Ù…Ø¯ Ù¾ÙˆØ±ÛŒØ§Ù†ÙØ±","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0013227173","name":"Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† ØµØ§Ø¯Ù‚ Ù†Ú˜Ø§Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0014880751","name":"Ø­Ø³Ø§Ù… ÙÙ„Ø§Ø­Øª Ù¾ÛŒØ´Ù‡","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"1360830634","name":"Ù…Ù‡Ø±Ø¯Ø§Ø¯ ØµØ§Ø¨Ø± Ù‚Ø±Ù‡ Ø¨Ø§Ø¨Ø§","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"4232135855","name":"Ù…Ø­Ù…Ø¯ ØµÛŒØ§Ø¯ÛŒ Ø³ÛŒ Ø³Ø®Øª","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"2980435430","name":"ÙØ§Ø¦Ø²Ù‡ Ø¨Ø§Ù‚Ø±ÛŒ Ù¾ÙˆØ±","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"1465352864","name":"Ø±ÙˆØ´Ù†Ú© Ù…Ø­Ù…Ø¯ÛŒØ§Ù†","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0451327926","name":"Ù„ÛŒÙ„Ø§ Ø§Ø­Ù…Ø¯ÛŒ Ø¢ÙˆØ±Ø²Ù…Ø§Ù†","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0310669081","name":"Ù…Ø±ØªØ¶ÛŒ Ù†ÛŒÚ©ÙˆØ¦ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0084697377","name":"Ù…Ø±ØªØ¶ÛŒ Ø´Ø§Ù‡ Ù…Ø­Ù…Ø¯ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"4560132534","name":"Ù¾Ø¯Ø±Ø§Ù… Ø¹Ø¨Ø¯Ø§Ù„Ù‡ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"2471739113","name":"Ø¹Ø§Ø·ÙÙ‡ Ø³Ø±Ù…Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0071114671","name":"Ø¹Ø±ÙØ§Ù†Ù‡ Ø³Ø§Ø¯Ø§Øª ÛŒØ²Ø¯Ø§Ù†Ø´Ù†Ø§Ø³","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0058084411","name":"ÛŒØ¹Ù‚ÙˆØ¨ Ø±Ø­ÛŒÙ…ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"2050322747","name":"Ø¹Ù„ÛŒØ±Ø¶Ø§ Ø´Ú©Ø± Ø§Ù„Ù‡ Ù†ÛŒØ§ Ø±ÙˆØ´Ù†","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0018553771","name":"ØµØ¯Ù Ø¹Ù„ÛŒ Ù†Ú˜Ø§Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"2080284665","name":"Ø·Ù‡ Ø¨Ø§Ù„Ø§ÛŒÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0019294638","name":"Ù¾Ú¯Ø§Ù‡ Ú©Ø±ÛŒÙ…ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 0"},
 {"code":"1742478638","name":"Ù„ÛŒÙ„Ø§ Ù…Ù†ÛŒØ´ Ø¯Ø§ÙˆÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 0"},
 {"code":"4592243331","name":"Ø±Ø¶Ø§ Ø¯Ø§ÙˆØ±Ù¾Ù†Ø§Ù‡","section":"Ø·Ø¨Ù‚Ù‡ 0"},
 {"code":"0059433876","name":"Ø¯Ø§ÙˆØ¯ Ø¯Ù„Ø§ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ø§","section":"Ø·Ø¨Ù‚Ù‡ 0"},
 {"code":"0025204599","name":"Ø¹Ù„ÛŒ Ø§Ø³Ú©Ù†Ø¯Ø±ÛŒ Ù†ØµÙÚ†ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0011911131","name":"Ù…Ø­Ù…Ø¯ ØµØ§Ø¯Ù‚ Ø±ÙÛŒØ¹ Ù¾ÙˆÛŒØ§","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0682486401","name":"Ú©Ø§ÙˆÙ‡ Ø±Ø¬Ø¨ Ù¾ÙˆØ± Ù…Ù‚Ø¯Ù…","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0023475919","name":"Ø²Ù‡Ø±Ø§ ÙÛŒÙ„Ø³ÙˆÙÛŒØ§Ù†","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"5669148134","name":"Ø­Ù‚ÛŒÙ‚Øª Ù†ÙˆØ±ÙˆØ²ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"}
];

const WORK_DAYS = ["Ø´Ù†Ø¨Ù‡","ÛŒÚ©Ø´Ù†Ø¨Ù‡","Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡"];
let menuDays = [];   // Ø§Ø² menu.json
let sides = [];      // Ø§Ø² menu.json

/* ---------- LOGIN ---------- */
function login(){
  const code = document.getElementById('userCode').value.trim();
  if(code === 'admin'){
    document.getElementById('loginDiv').style.display='none';
    document.getElementById('adminDiv').style.display='block';
    document.getElementById('whoAmI').textContent='Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…';
    return;
  }
  const u = users.find(x=>x.code===code);
  if(!u){ document.getElementById('loginMsg').textContent='Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª!'; return; }
  localStorage.setItem('currentUser',u.code);
  localStorage.setItem('currentUserName',u.name);
  localStorage.setItem('currentUserSection',u.section);
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('orderDiv').style.display='block';
  document.getElementById('helloText').textContent=`Ø³Ù„Ø§Ù… ${u.name} (${u.section})`;
  document.getElementById('whoAmI').textContent=`${u.name} â€¢ ${u.section}`;
  renderWeeklyForm();
}

function logout(){
  document.getElementById('orderDiv').style.display='none';
  document.getElementById('adminDiv').style.display='none';
  document.getElementById('loginDiv').style.display='block';
  document.getElementById('whoAmI').textContent='';
}

/* ---------- HELPERS ---------- */
function workingSlice(){
  return (menuDays||[]).filter(d=>{
    const inRange = d.jdate >= "1404/06/08" && d.jdate <= "1404/06/21";
    return inRange && WORK_DAYS.includes(d.weekday);
  });
}

function updateSubmitEnabled(){
  const btn = document.getElementById('submitBtn');
  const rows = document.querySelectorAll('[data-row="order"]');
  let allOk = true;
  rows.forEach(row=>{
    const selMeal = row.querySelector('select[data-kind="meal"]');
    const selSide = row.querySelector('select[data-kind="side"]');
    if(!selMeal || !selSide) return; // Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ø³ÙÙ„Ú©Øª (Ù…Ø«Ù„Ø§Ù‹ Ø§Ú¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯) Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±
    const mOk = selMeal.value !== "";
    const sOk = selSide.value !== "";
    selMeal.classList.toggle('invalid', !mOk);
    selSide.classList.toggle('invalid', !sOk);
    allOk = allOk && (mOk && sOk);
  });
  btn.disabled = !allOk;
}

/* ---------- RENDER WEEK (Fix: Ø±ÙˆØ²Ù‡Ø§ÛŒ ØªØ¹Ø·ÛŒÙ„ data-row Ù†Ø¯Ø§Ø±Ù†Ø¯) ---------- */
function renderWeeklyForm(){
  const box = document.getElementById('weeklyContainer');
  const holBar = document.getElementById('holidayBar');
  box.innerHTML='';

  const offs = workingSlice().filter(d=>d.off);
  if(offs.length){
    holBar.style.display='block';
    holBar.textContent = "ØªØ¹Ø·ÛŒÙ„ÛŒâ€ŒÙ‡Ø§: " + offs.map(o=>`${o.jdate} (${o.weekday})`).join(' ØŒ ');
  } else { holBar.style.display='none'; }

  const days = workingSlice();
  days.forEach(item=>{
    if(item.off || !item.menu){
      // â— Ø§ÛŒÙ†Ø¬Ø§ Ø¯ÛŒÚ¯Ø± data-row="order" Ù†Ø¯Ø§Ø±ÛŒÙ… ØªØ§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø´Ù…Ø±Ø¯Ù‡ Ù†Ø´ÙˆØ¯
      box.insertAdjacentHTML('beforeend', `
        <div class="grid-day">
          <div class="badge off" data-day="${item.weekday}">${item.jdate} â€” ${item.weekday}</div>
          <div style="grid-column:span 2;opacity:.7">ØªØ¹Ø·ÛŒÙ„ / Ø¨Ø¯ÙˆÙ† Ù…Ù†Ùˆ</div>
        </div>
      `);
      return;
    }
    const m = item.menu; const keys = Object.keys(m); // Ù†ÙˆØ¹1ØŒ Ù†ÙˆØ¹2ØŒ Ù†ÙˆØ¹3
    box.insertAdjacentHTML('beforeend', `
      <div class="grid-day" data-row="order">
        <div class="badge" data-day="${item.weekday}">${item.jdate} â€” ${item.weekday}</div>
        <select id="meal_${item.jdate}" class="placeholder" data-kind="meal" onchange="this.classList.remove('placeholder');updateSubmitEnabled()">
          <option value="" selected disabled>â€” Ø§Ù†ØªØ®Ø§Ø¨ ØºØ°Ø§ â€”</option>
          ${keys.map(k=>`<option value="${m[k]}">${m[k]} (${k})</option>`).join('')}
        </select>
        <select id="side_${item.jdate}" class="placeholder" data-kind="side" onchange="this.classList.remove('placeholder');updateSubmitEnabled()">
          <option value="" selected disabled>â€” Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†Ø§Ø±ØºØ°Ø§ â€”</option>
          ${sides.map(s=>`<option value="${s}">${s}</option>`).join('')}
        </select>
      </div>
    `);
  });

  updateSubmitEnabled();
}

/* ---------- SUBMIT ---------- */
async function submitOrder(){
  const code = localStorage.getItem('currentUser');
  const name = localStorage.getItem('currentUserName');
  const section = localStorage.getItem('currentUserSection');
  if(!code){ alert('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.'); return; }

  const slice = workingSlice().filter(d=>!d.off && d.menu);
  const missing = [];
  const rows = [];
  slice.forEach(d=>{
    const meal = document.getElementById(`meal_${d.jdate}`)?.value || "";
    const side = document.getElementById(`side_${d.jdate}`)?.value || "";
    if(!meal || !side) missing.push(`${d.jdate} (${d.weekday})`);
    else rows.push({code,name,section,jdate:d.jdate,weekday:d.weekday,meal,side});
  });

  if(missing.length){
    const first = missing[0];
    document.getElementById('orderMsg').textContent = "";
    const p = document.getElementById('progressMsg');
    p.style.display='block';
    p.textContent = "Ø§ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯: " + missing.join(" ØŒ ");
    document.getElementById(`meal_${first.split(" ")[0]}`)?.scrollIntoView({behavior:'smooth',block:'center'});
    return;
  }

  const btn = document.getElementById('submitBtn');
  const pmsg = document.getElementById('progressMsg');
  btn.disabled = true;
  pmsg.style.display='block';
  pmsg.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§â€¦";

  try{
    const res = await fetch(SHEET_URL, {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(rows)
    });
    const data = await res.json();
    if(data.ok){
      document.getElementById('orderMsg').textContent = `Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ Ø«Ø¨Øª Ø´Ø¯ âœ… (ØªØ¹Ø¯Ø§Ø¯: ${rows.length})`;
      pmsg.style.display='none';
    }else{
      document.getElementById('orderMsg').textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ âŒ";
      pmsg.style.display='none';
      btn.disabled = false;
    }
  }catch(e){
    document.getElementById('orderMsg').textContent = "Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ âŒ";
    pmsg.style.display='none';
    btn.disabled = false;
  }
}

/* ---------- ADMIN: load & CSV from sheet ---------- */
async function loadSheet(){
  try{
    const url = `${SHEET_URL}?from=1404/06/08&to=1404/06/21`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data.ok){ alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§'); return; }
    const rows = data.rows || [];
    const tbody = document.querySelector('#ordersTable tbody');
    tbody.innerHTML='';
    rows.forEach(r=>{
      tbody.insertAdjacentHTML('beforeend',
        `<tr>
          <td>${r.code||''}</td>
          <td>${r.name||''}</td>
          <td>${r.section||''}</td>
          <td>${r.jdate||''}</td>
          <td>${r.weekday||''}</td>
          <td>${r.meal||''}</td>
          <td>${r.side||''}</td>
        </tr>`);
    });
    alert(`ØªØ¹Ø¯Ø§Ø¯ Ø±Ø¯ÛŒÙ Ø®ÙˆØ§Ù†Ø¯Ù‡â€ŒØ´Ø¯Ù‡: ${rows.length}`);
  }catch(e){ alert('Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§'); }
}

function exportWeekCSVFromSheet(){
  const tbody=document.querySelector('#ordersTable tbody');
  if(!tbody.children.length){ alert('Ø§ÙˆÙ„ Â«Ø®ÙˆØ§Ù†Ø¯Ù† Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.'); return; }
  let csv="Ú©Ø¯ Ù…Ù„ÛŒ,Ù†Ø§Ù…,Ø¨Ø®Ø´,ØªØ§Ø±ÛŒØ®,Ø±ÙˆØ²,ØºØ°Ø§,Ú©Ù†Ø§Ø±ØºØ°Ø§\n";
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    const tds=[...tr.children].map(td=>(td.textContent||'').replaceAll(',','ØŒ'));
    csv+=tds.join(",")+"\n";
  });
  downloadCSV("\uFEFF"+csv,"orders_1404-06-08_1404-06-21.csv");
}
function exportDailyByFloorCSVFromSheet(){
  const tbody=document.querySelector('#ordersTable tbody');
  if(!tbody.children.length){ alert('Ø§ÙˆÙ„ Â«Ø®ÙˆØ§Ù†Ø¯Ù† Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.'); return; }
  const rows=[...tbody.querySelectorAll('tr')].map(tr=>{
    const td=tr.children; return {code:td[0].textContent,name:td[1].textContent,section:td[2].textContent,
      jdate:td[3].textContent,weekday:td[4].textContent,meal:td[5].textContent,side:td[6].textContent};
  });
  const dayOrder=["Ø´Ù†Ø¨Ù‡","ÛŒÚ©Ø´Ù†Ø¨Ù‡","Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡"];
  const days=[...new Set(rows.map(r=>r.weekday))].filter(d=>dayOrder.includes(d))
              .sort((a,b)=>dayOrder.indexOf(a)-dayOrder.indexOf(b));
  days.forEach(day=>{
    const floors=[...new Set(rows.map(r=>r.section))];
    let parts=[];
    floors.forEach(f=>{
      let block = `Ø·Ø¨Ù‚Ù‡: ${f}\nÚ©Ø¯ Ù…Ù„ÛŒ,Ù†Ø§Ù…,${day}\n`;
      rows.filter(r=>r.section===f && r.weekday===day).forEach(r=>{
        const cell=[r.meal,r.side].filter(Boolean).join(" + ");
        block+=`${r.code},${r.name},${cell}\n`;
      });
      parts.push(block);
    });
    downloadCSV("\uFEFF"+parts.join("\n"),`orders_${day}_by_floor.csv`);
  });
}
function downloadCSV(text, filename){
  const blob=new Blob([text],{type:"text/csv;charset=utf-8"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),0);
}

/* ---------- load menu.json ---------- */
async function loadMenu(){
  try{
    const res = await fetch(MENU_URL + "?v=" + Date.now());
    const data = await res.json();
    menuDays = data.days || [];
    sides = (data.sides || ["Ù†ÙˆØ´Ø§Ø¨Ù‡","Ø¯ÙˆØº","Ø³Ø§Ù„Ø§Ø¯"]).filter(s=>s!=="Ù…Ø§Ø³Øª"); // Ù…Ø§Ø³Øª Ø­Ø°Ù
    document.getElementById('menuStatus').textContent = 'Ù…Ù†Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ âœ…';
  }catch(e){
    document.getElementById('menuStatus').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ù†Ùˆ âŒ';
  }
}
loadMenu();
</script>
</body>
</html>