<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>سفارش غذای شرکتی - ماهانه</title>
<link rel="icon" href="logo.png" />
<style>
  :root{
    --bg:#0f172a; --card:rgba(255,255,255,.08); --card-border:rgba(255,255,255,.18);
    --text:#e6edf6; --muted:#b6c2d9; --accent:#22c55e; --accent-strong:#16a34a;
    --danger:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.25); --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tahoma,system-ui;background:var(--bg);color:var(--text);line-height:1.7;}
  header{
    padding:16px;text-align:center;background:#1e293b;color:#fff;font-weight:800;letter-spacing:.2px;
    display:flex;flex-direction:column;align-items:center;gap:8px
  }
  header .logo{width:84px;height:auto;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.4)}
  header h1{margin:0;font-size:20px}
  .subhead{font-size:13px;color:#cbd5e1;margin-top:4px}
  #whoAmI{color:var(--muted);font-size:14px;margin-top:6px}
  .container{max-width:1100px;margin:24px auto;padding:0 18px}
  .card{
    background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);
    box-shadow:var(--shadow);padding:24px;margin:14px auto;text-align:center
  }
  h2{margin:6px 0 16px}
  .muted{color:var(--muted)}
  .row{display:grid;gap:12px}
  .two-col{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media (max-width:900px){.two-col{grid-template-columns:1fr}}
  .grid-day{display:grid;gap:12px;grid-template-columns:220px 1fr 1fr}
  @media (max-width:800px){.grid-day{grid-template-columns:1fr}}
  .input,.select,.button{
    width:100%;padding:12px 14px;font-size:16px;border-radius:12px;border:1px solid var(--card-border);
    background:rgba(255,255,255,.07);color:var(--text);outline:none
  }
  .select{font-weight:700;text-align:center;appearance:none;-webkit-appearance:none}
  .button{cursor:pointer;font-weight:800;background:linear-gradient(180deg,var(--accent),var(--accent-strong));border:none}
  .button:hover{filter:brightness(1.05)}
  .danger{background:linear-gradient(180deg,var(--danger),#b91c1c)!important}
  .badge{
    padding:12px;border-radius:12px;font-weight:800;text-align:center;color:#fff;border:1px solid var(--card-border)
  }
  .badge[data-day*="شنبه"]{background:#ef4444}
  .badge[data-day*="یکشنبه"]{background:#f59e0b}
  .badge[data-day*="دوشنبه"]{background:#10b981}
  .badge[data-day*="سه‌شنبه"]{background:#3b82f6}
  .badge[data-day*="چهارشنبه"]{background:#8b5cf6}
  .week-card{
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.06);
    border-radius:12px; padding:12px; margin:10px 0; text-align:right
  }
  .week-title{font-weight:800;margin:0 0 8px}
  .strike{opacity:.55; text-decoration: line-through; filter: grayscale(1)}
  .disabled{pointer-events:none; opacity:.55}
  .ok{color:#34d399}
  .err{color:#ff6b6b}
  .small{font-size:12px;color:#cbd5e1}
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="لوگوی شرکت" class="logo">
  <h1>🍽️ سفارش غذای ماهانه</h1>
  <div class="subhead" id="todayBar">امروز (شمسی): …</div>
  <div id="whoAmI"></div>
</header>

<div class="container">
  <!-- ورود -->
  <div class="card" id="loginDiv">
    <h2>ورود</h2>
    <p class="muted">کد ملی را وارد کنید. (مدیر: <b>admin</b>)</p>
    <div class="two-col">
      <input id="userCode" class="input" type="text" placeholder="مثلاً 0012345678 یا admin" />
      <button class="button" onclick="login()">ورود</button>
    </div>
    <p id="loginMsg" class="err"></p>
  </div>

  <!-- انتخاب ماهانه -->
  <div class="card" id="orderDiv" style="display:none;">
    <h2>انتخاب غذا برای <span id="monthTitle">ماه جاری</span></h2>
    <p id="helloText" class="muted"></p>
    <div id="monthContainer"></div>
    <div class="two-col" style="margin-top:12px">
      <button class="button" onclick="submitMonthOrder()">ثبت سفارش ماه</button>
      <button class="button danger" onclick="logout()">بازگشت</button>
    </div>
    <p id="orderMsg" class="ok"></p>
    <p class="small">* روزهای موجود از فایل <b>menu.json</b> خوانده می‌شوند.</p>
  </div>

  <!-- مدیر: فقط مشاهده JSON و لینک‌ها -->
  <div class="card" id="adminDiv" style="display:none;">
    <h2>منوی ماه (خوانده‌شده از JSON)</h2>
    <pre id="jsonPreview" style="text-align:left;direction:ltr;max-height:320px;overflow:auto;background:rgba(0,0,0,.3);padding:12px;border-radius:10px"></pre>
    <div class="two-col" style="margin-top:12px">
      <button class="button" onclick="openMenuOnGitHub()">باز کردن menu.json در GitHub</button>
      <button class="button" onclick="copyRawMenuLink()">کپی لینک مستقیم menu.json</button>
    </div>
    <button class="button danger" style="margin-top:12px" onclick="logout()">بازگشت</button>
  </div>
</div>

<script>
/* ـــــــــــــ تنظیمات ـــــــــــــ */
// آدرس RAW فایل menu.json خودت را بگذار:
const MENU_JSON_URL = "https://raw.githubusercontent.com/alieskandari4599/company-food-order/main/menu.json";

/* کارکنان (کامل) */
const users = [
 {"code":"1465316159","name":"علی اصغرزاده صادق","section":"طبقه 4"},
 {"code":"0939825902","name":"سید علی میرتونی","section":"طبقه 4"},
 {"code":"0075102110","name":"محسن اشرف اسلامی","section":"طبقه 4"},
 {"code":"1532626142","name":"زهرا محمدی حلمسلوئی","section":"طبقه 4"},
 {"code":"2710033445","name":"مسعود قاسم زاده سیاهکل","section":"طبقه 3"},
 {"code":"1263594301","name":"مهدی نوروزی خزاقی","section":"طبقه 3"},
 {"code":"0010275975","name":"لیلا رسولی درآباد","section":"طبقه 3"},
 {"code":"0014668688","name":"محمدرضا عبدالهی","section":"طبقه 3"},
 {"code":"0051385090","name":"شاهین فاضل مهر","section":"طبقه 3"},
 {"code":"1450551394","name":"فاطمه پارسای","section":"طبقه 3"},
 {"code":"1263591310","name":"مقداد شفقی","section":"طبقه 3"},
 {"code":"0020090641","name":"فاطمه میرزاخانی","section":"طبقه 3"},
 {"code":"0077320980","name":"جواد مرادپور","section":"طبقه 1"},
 {"code":"0082878110","name":"الناز نوروزی","section":"طبقه 2"},
 {"code":"5449975856","name":"ولی اله غنجی فشکی","section":"طبقه 2"},
 {"code":"0013322214","name":"زهرا بابایی","section":"طبقه 2"},
 {"code":"0076209441","name":"محمد پوریانفر","section":"طبقه 2"},
 {"code":"0013227173","name":"امیرحسین صادق نژاد","section":"طبقه 2"},
 {"code":"0014880751","name":"حسام فلاحت پیشه","section":"طبقه 2"},
 {"code":"1360830634","name":"مهرداد صابر قره بابا","section":"طبقه 2"},
 {"code":"4232135855","name":"محمد صیادی سی سخت","section":"طبقه 2"},
 {"code":"2980435430","name":"فائزه باقری پور","section":"طبقه 2"},
 {"code":"1465352864","name":"روشنک محمدیان","section":"طبقه 2"},
 {"code":"0451327926","name":"لیلا احمدی آورزمان","section":"طبقه 3"},
 {"code":"0310669081","name":"مرتضی نیکوئی","section":"طبقه 1"},
 {"code":"0084697377","name":"مرتضی شاه محمدی","section":"طبقه 1"},
 {"code":"4560132534","name":"پدرام عبدالهی","section":"طبقه 1"},
 {"code":"2471739113","name":"عاطفه سرمد","section":"طبقه 1"},
 {"code":"0071114671","name":"عرفانه سادات یزدانشناس","section":"طبقه 1"},
 {"code":"0058084411","name":"یعقوب رحیمی","section":"طبقه 1"},
 {"code":"2050322747","name":"علیرضا شکر اله نیا روشن","section":"طبقه 1"},
 {"code":"0018553771","name":"صدف علی نژاد","section":"طبقه 1"},
 {"code":"2080284665","name":"طه بالایی","section":"طبقه 1"},
 {"code":"0019294638","name":"پگاه کریمی","section":"طبقه 0"},
 {"code":"1742478638","name":"لیلا منیش داوی","section":"طبقه 0"},
 {"code":"4592243331","name":"رضا داورپناه","section":"طبقه 0"},
 {"code":"0059433876","name":"داود دلاوری پارسا","section":"طبقه 0"},
 {"code":"0025204599","name":"علی اسکندری نصفچی","section":"طبقه 3"},
 {"code":"0011911131","name":"محمد صادق رفیع پویا","section":"طبقه 3"},
 {"code":"0682486401","name":"کاوه رجب پور مقدم","section":"طبقه 2"},
 {"code":"0023475919","name":"زهرا فیلسوفیان","section":"طبقه 1"},
 {"code":"5669148134","name":"حقیقت نوروزی","section":"طبقه 2"}
];

let monthMenu = { weeks:{}, sideItems:[], holidays:[] };
let currentUser = null;

/* ابزار شمسی برای نمایش امروز */
function toJalali(gY,gM,gD){
  const gdm=[31,28,31,30,31,30,31,31,30,31,30,31], jdm=[31,31,31,31,31,31,30,30,30,30,30,29];
  let gy=gY-1600, gm=gM-1, gd=gD-1, gDayNo=365*gy+Math.floor((gy+3)/4)-Math.floor((gy+99)/100)+Math.floor((gy+399)/400);
  for(let i=0;i<gm;++i) gDayNo+=gdm[i];
  if(gm>1 && ((gY%4===0 && gY%100!==0)||(gY%400===0))) gDayNo++;
  gDayNo+=gd;
  let jDayNo=gDayNo-79, jNp=Math.floor(jDayNo/12053); jDayNo%=12053;
  let jy=979+33*jNp+4*Math.floor(jDayNo/1461); jDayNo%=1461;
  if(jDayNo>=366){ jy+=Math.floor((jDayNo-366)/365); jDayNo=(jDayNo-366)%365; }
  let jm=0; for(;jm<11 && jDayNo>=jdm[jm]; ++jm) jDayNo-=jdm[jm];
  let jd=jDayNo+1; return {jy, jm:jm+1, jd};
}
function todayText(){
  const d=new Date(); const j=toJalali(d.getFullYear(),d.getMonth()+1,d.getDate());
  const pad=n=>String(n).padStart(2,"0"); return `${j.jy}/${pad(j.jm)}/${pad(j.jd)}`;
}

/* خواندن menu.json (RAW) */
async function fetchMenuJSON(){
  const res = await fetch(MENU_JSON_URL + "?" + Date.now());
  if(!res.ok){ throw new Error("menu.json not found"); }
  const json = await res.json();
  if(json.weeks){
    monthMenu.weeks = json.weeks || {};
    monthMenu.sideItems = json.sideItems || [];
    monthMenu.holidays = json.holidays || [];
  }else if(json.weeklyMenu){
    monthMenu.weeks = { "هفته 1": {} };
    Object.keys(json.weeklyMenu).forEach(k=>{
      // اگر فقط نام روز است، مستقیماً همان را کلید قرار می‌دهیم
      monthMenu.weeks["هفته 1"][k] = json.weeklyMenu[k];
    });
    monthMenu.sideItems = json.sideItems || [];
    monthMenu.holidays = [];
  }else{
    monthMenu = {weeks:{}, sideItems:[], holidays:[]};
  }
}

/* ورود */
async function login(){
  const code = document.getElementById("userCode").value.trim();
  if(!code){ document.getElementById("loginMsg").textContent="کد ملی را وارد کنید."; return; }

  try{ await fetchMenuJSON(); }catch(e){
    document.getElementById("loginMsg").textContent="خواندن منو از menu.json ناموفق بود.";
    return;
  }

  if(code==="admin"){
    currentUser = {code:"admin", name:"مدیر سیستم", section:""};
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("adminDiv").style.display="block";
    document.getElementById("whoAmI").textContent = "مدیر سیستم";
    document.getElementById("jsonPreview").textContent = JSON.stringify(monthMenu, null, 2);
    return;
  }

  const u = users.find(x=>x.code===code);
  if(!u){ document.getElementById("loginMsg").textContent="کد ملی معتبر نیست!"; return; }
  currentUser = u;
  document.getElementById("loginDiv").style.display="none";
  document.getElementById("orderDiv").style.display="block";
  document.getElementById("helloText").textContent = `سلام ${u.name} (${u.section})`;
  document.getElementById("whoAmI").textContent = `${u.name} • ${u.section}`;
  renderMonthForm();
}

/* خروج */
function logout(){
  currentUser = null;
  document.getElementById("orderDiv").style.display="none";
  document.getElementById("adminDiv").style.display="none";
  document.getElementById("loginDiv").style.display="block";
  document.getElementById("whoAmI").textContent="";
  document.getElementById("orderMsg").textContent="";
}

/* فرم ماهانه: بر اساس weeks و holidays در JSON */
function renderMonthForm(){
  const container = document.getElementById("monthContainer");
  container.innerHTML = "";
  const sideItems = monthMenu.sideItems || [];
  let monthTitle = "";

  const weekKeys = Object.keys(monthMenu.weeks||{}).sort((a,b)=>{
    const na = parseInt((a.match(/\d+/)||[0])[0],10);
    const nb = parseInt((b.match(/\d+/)||[0])[0],10);
    return na-nb;
  });

  weekKeys.forEach((wkKey, wIdx)=>{
    const weekObj = monthMenu.weeks[wkKey] || {};
    const card = document.createElement("div");
    card.className = "week-card";

    const dayKeys = Object.keys(weekObj);
    const first = dayKeys[0] || "";
    const last  = dayKeys[dayKeys.length-1] || "";
    const range = (first && last) ? `${first.split(" ")[0]} تا ${last.split(" ")[0]}` : "";

    if(!monthTitle && first){ monthTitle = first.split("/").slice(0,2).join("/"); }

    card.innerHTML = `<div class="week-title">${wkKey} ${range ? "— " + range : ""}</div>`;

    dayKeys.forEach((label, dIdx)=>{
      const parts = label.split(" "); // "YYYY/MM/DD شنبه"
      const jdate = parts[0] || "";
      const dayName = parts[1] || "";
      const isHoliday = (monthMenu.holidays||[]).includes(jdate) || /جمعه|پنجشنبه/.test(dayName);

      const meals = weekObj[label] || {خوراک:"-",کبابی:"-",خورشتی:"-"};

      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="grid-day ${isHoliday ? "disabled" : ""}">
          <div class="badge ${isHoliday ? "strike": ""}" data-day="${dayName}">${label}</div>
          <select id="meal_${wIdx}_${dIdx}" class="select" ${isHoliday?"disabled":""}>
            <option value="${meals.خوراک}">${meals.خوراک} (خوراک)</option>
            <option value="${meals.کبابی}">${meals.کبابی} (کبابی)</option>
            <option value="${meals.خورشتی}">${meals.خورشتی} (خورشتی)</option>
          </select>
          <select id="side_${wIdx}_${dIdx}" class="select" ${isHoliday?"disabled":""}>
            ${sideItems.map(s=>`<option value="${s}">${s}</option>`).join("")}
          </select>
        </div>`;
      card.appendChild(row);
    });

    container.appendChild(card);
  });

  document.getElementById("monthTitle").textContent = monthTitle ? `ماه ${monthTitle}` : "ماه جاری";
}

/* ذخیره سفارش ماه (Local در دستگاه فعلی) */
function submitMonthOrder(){
  if(!currentUser){ return; }
  const container = document.getElementById("monthContainer");
  const rows = container.querySelectorAll(".week-card .row");

  const orders = [];
  rows.forEach((row)=>{
    const grid = row.querySelector(".grid-day");
    if(grid.classList.contains("disabled")) return; // تعطیل‌ها حذف

    const badge = row.querySelector(".badge");
    const label = badge?.textContent?.trim() || "";
    const selects = row.querySelectorAll("select");
    if(selects.length<2) return;
    const meal = selects[0].value;
    const side = selects[1].value;
    orders.push({ label, meal, side });
  });

  const key = `order_month_${currentUser.code}_${Date.now()}`;
  const payload = {
    code: currentUser.code,
    name: currentUser.name,
    section: currentUser.section,
    orders
  };
  localStorage.setItem(key, JSON.stringify(payload));
  document.getElementById("orderMsg").textContent = "سفارش ماهانه ثبت شد ✅";
}

/* ابزار مدیر برای JSON */
function openMenuOnGitHub(){
  const url = MENU_JSON_URL.replace("raw.githubusercontent.com","github.com").replace("/main/","/blob/main/");
  window.open(url, "_blank");
}
function copyRawMenuLink(){
  navigator.clipboard?.writeText(MENU_JSON_URL);
  alert("Copied:\n"+MENU_JSON_URL);
}

/* بوت */
(function boot(){
  document.getElementById("todayBar").textContent = "امروز (شمسی): " + todayText();
})();
</script>

</body>
</html>
