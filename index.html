<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MES BROKER</title>
<link rel="" href="logo.png" />
<!-- Ø§Ú©Ø³Ù„ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0f172a; --card:rgba(255,255,255,.08); --card-border:rgba(255,255,255,.18);
    --text:#e6edf6; --muted:#b6c2d9; --accent:#22c55e; --accent-strong:#16a34a;
    --danger:#ef4444; --ok:#34d399; --shadow:0 10px 30px rgba(0,0,0,.25); --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tahoma,system-ui;background:var(--bg);color:var(--text);line-height:1.7;}
  header{
    padding:16px;text-align:center;background:#1e293b;color:#fff;font-weight:800;letter-spacing:.2px;
    display:flex;flex-direction:column;align-items:center;gap:8px
  }
  header .logo{width:84px;height:auto;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.4)}
  header h1{margin:0;font-size:20px}
  .subhead{font-size:13px;color:#cbd5e1;margin-top:4px}
  #whoAmI{color:var(--muted);font-size:14px;margin-top:6px}
  .container{max-width:1100px;margin:24px auto;padding:0 18px}
  .card{
    background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);
    box-shadow:var(--shadow);padding:24px;margin:14px auto;text-align:center
  }
  h2{margin:6px 0 16px}
  .muted{color:var(--muted)}
  .row{display:grid;gap:12px}
  .two-col{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media (max-width:900px){.two-col{grid-template-columns:1fr}}
  .grid-day{display:grid;gap:12px;grid-template-columns:160px 1fr 1fr}
  @media (max-width:800px){.grid-day{grid-template-columns:1fr}}
  .input,.select,.button,textarea{
    width:100%;padding:12px 14px;font-size:16px;border-radius:12px;border:1px solid var(--card-border);
    background:rgba(255,255,255,.07);color:var(--text);outline:none
  }
  .select{font-weight:700;text-align:center}
  .button{cursor:pointer;font-weight:800;background:linear-gradient(180deg,var(--accent),var(--accent-strong));border:none}
  .button:hover{filter:brightness(1.05)}
  .danger{background:linear-gradient(180deg,var(--danger),#b91c1c)!important}
  .badge{
    padding:12px;border-radius:12px;font-weight:800;text-align:center;color:#fff;border:1px solid var(--card-border)
  }
  /* Ø±Ù†Ú¯ Ù‡Ø± Ø±ÙˆØ² */
  .badge[data-day="Ø´Ù†Ø¨Ù‡"]{background:#ef4444}
  .badge[data-day="ÛŒÚ©Ø´Ù†Ø¨Ù‡"]{background:#f59e0b}
  .badge[data-day="Ø¯ÙˆØ´Ù†Ø¨Ù‡"]{background:#10b981}
  .badge[data-day="Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡"]{background:#3b82f6}
  .badge[data-day="Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡"]{background:#8b5cf6}
  .today-ring{outline:3px solid rgba(255,255,255,.55);outline-offset:2px}

  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;overflow:hidden;border-radius:12px}
  thead th{background:rgba(255,255,255,.1)}
  th,td{border-bottom:1px solid rgba(255,255,255,.12);padding:8px;text-align:center;font-size:14px}
  tbody tr:nth-child(odd){background:rgba(255,255,255,.04)}
  .section{border:1px dashed rgba(255,255,255,.2);padding:14px;border-radius:12px;text-align:right}
  .section h3{margin:0 0 8px;font-size:16px}
</style>
</head>
<body>

<header>
  <img src="assets/WhatsApp Image 2025-08-20 at 20.49.10.jpeg" alt="Ù„ÙˆÚ¯ÙˆÛŒ Ø´Ø±Ú©Øª" class="logo">
  <h1>ğŸ½ï¸ </h1>
  <div class="subhead" id="todayBar">Ø§Ù…Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ): ...</div>
  <div id="whoAmI"></div>
</header>

<div class="container">
  <!-- ÙˆØ±ÙˆØ¯ -->
  <div class="card" id="loginDiv">
    <h2>ÙˆØ±ÙˆØ¯</h2>
    <p class="muted">Ú©Ø¯ Ù…Ù„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. </p>
    <div class="row">
      <input id="userCode" class="input"  />
      <button class="button" onclick="login()">ÙˆØ±ÙˆØ¯</button>
      <p id="loginMsg" style="color:#ff6b6b"></p>
    </div>
  </div>

  <!-- Ø§Ù†ØªØ®Ø§Ø¨ ØºØ°Ø§ (Ú©Ø§Ø±Ø¨Ø±) -->
  <div class="card" id="orderDiv" style="display:none;">
    <h2>Ø§Ù†ØªØ®Ø§Ø¨ ØºØ°Ø§ Ùˆ Ù‡Ù…Ø±Ø§Ù‡</h2>
    <p id="helloText" class="muted"></p>
    <div id="daysContainer"></div>
    <div class="two-col" style="margin-top:12px">
      <button class="button" onclick="submitOrder()">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
      <button class="button danger" onclick="logout()">Ø®Ø±ÙˆØ¬ / Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>
    <p id="orderMsg" style="color:#34d399"></p>
  </div>

  <!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± -->
  <div class="card" id="adminDiv" style="display:none;">
    <h2>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
    <p class="muted">Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±ÙˆØ² Ù‡ÙØªÙ‡ ÛŒÚ© <b>Ø®ÙˆØ±Ø§Ú©</b>ØŒ ÛŒÚ© <b>Ú©Ø¨Ø§Ø¨ÛŒ</b> Ùˆ ÛŒÚ© <b>Ø®ÙˆØ±Ø´ØªÛŒ</b> Ø¨Ù†ÙˆÛŒØ³. Ù„ÛŒØ³Øª Â«Ú©Ù†Ø§Ø± ØºØ°Ø§Ù‡Ø§Â» Ù‡Ù… Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø³Øª.</p>
    <div id="menuEditor" class="two-col" style="margin-top:10px"></div>

    <div class="two-col" style="margin-top:10px">
      <button class="button" onclick="saveMenu()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù…Ù†Ùˆ</button>
      <button class="button danger" onclick="logout()">Ø®Ø±ÙˆØ¬ / Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <hr style="border-color:rgba(255,255,255,.15);margin:18px 0">

    <h2>Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</h2>
    <div class="two-col">
      <button class="button" onclick="exportExcelAll()">ğŸ“¥ Ø§Ú©Ø³Ù„: Ú©Ù„ Ù‡ÙØªÙ‡ (ÛŒÚ© Ø´ÛŒØª)</button>
      <button class="button" onclick="exportExcelDailyByFloor()">ğŸ“¥ Ø§Ú©Ø³Ù„: Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø·Ø¨Ù‚Ù‡</button>
      <button class="button" onclick="exportExcelTodayByFloorJalali()">ğŸ“¥ Ø§Ú©Ø³Ù„: Ø§Ù…Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ) Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø·Ø¨Ù‚Ù‡</button>
    </div>

    <table id="ordersTable">
      <thead>
        <tr>
          <th>Ú©Ø¯ Ù…Ù„ÛŒ</th><th>Ù†Ø§Ù…</th><th>Ø¨Ø®Ø´</th>
          <th>Ø´Ù†Ø¨Ù‡</th><th>ÛŒÚ©Ø´Ù†Ø¨Ù‡</th><th>Ø¯ÙˆØ´Ù†Ø¨Ù‡</th><th>Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</th><th>Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ===== Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ù¾Ø±Ø³Ù†Ù„ Ø¨Ø§ Ø·Ø¨Ù‚Ù‡ ===== */
const users = [
 {code:"1465316159",name:"Ø¹Ù„ÛŒ Ø§ØµØºØ±Ø²Ø§Ø¯Ù‡ ØµØ§Ø¯Ù‚",section:"Ø·Ø¨Ù‚Ù‡ 4"},
 {code:"0939825902",name:"Ø³ÛŒØ¯ Ø¹Ù„ÛŒ Ù…ÛŒØ±ØªÙˆÙ†ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 4"},
 {code:"0075102110",name:"Ù…Ø­Ø³Ù† Ø§Ø´Ø±Ù Ø§Ø³Ù„Ø§Ù…ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 4"},
 {code:"1532626142",name:"Ø²Ù‡Ø±Ø§ Ù…Ø­Ù…Ø¯ÛŒ Ø­Ù„Ù…Ø³Ù„ÙˆØ¦ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 4"},
 {code:"2710033445",name:"Ù…Ø³Ø¹ÙˆØ¯ Ù‚Ø§Ø³Ù… Ø²Ø§Ø¯Ù‡ Ø³ÛŒØ§Ù‡Ú©Ù„",section:"Ø·Ø¨Ù‚Ù‡ 3"},
 {code:"1263594301",name:"Ù…Ù‡Ø¯ÛŒ Ù†ÙˆØ±ÙˆØ²ÛŒ Ø®Ø²Ø§Ù‚ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 3"},
 {code:"0010275975",name:"Ù„ÛŒÙ„Ø§ Ø±Ø³ÙˆÙ„ÛŒ Ø¯Ø±Ø¢Ø¨Ø§Ø¯",section:"Ø·Ø¨Ù‚Ù‡ 3"},
 {code:"0014668688",name:"Ù…Ø­Ù…Ø¯Ø±Ø¶Ø§ Ø¹Ø¨Ø¯Ø§Ù„Ù‡ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 3"},
 {code:"0051385090",name:"Ø´Ø§Ù‡ÛŒÙ† ÙØ§Ø¶Ù„ Ù…Ù‡Ø±",section:"Ø·Ø¨Ù‚Ù‡ 3"},
 {code:"1450551394",name:"ÙØ§Ø·Ù…Ù‡ Ù¾Ø§Ø±Ø³Ø§ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 3"},
 {code:"1263591310",name:"Ù…Ù‚Ø¯Ø§Ø¯ Ø´ÙÙ‚ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 3"},
 {code:"0020090641",name:"ÙØ§Ø·Ù…Ù‡ Ù…ÛŒØ±Ø²Ø§Ø®Ø§Ù†ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 3"},
 {code:"0077320980",name:"Ø¬ÙˆØ§Ø¯ Ù…Ø±Ø§Ø¯Ù¾ÙˆØ±",section:"Ø·Ø¨Ù‚Ù‡ 1"},
 {code:"0082878110",name:"Ø§Ù„Ù†Ø§Ø² Ù†ÙˆØ±ÙˆØ²ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 2"},
 {code:"5449975856",name:"ÙˆÙ„ÛŒ Ø§Ù„Ù‡ ØºÙ†Ø¬ÛŒ ÙØ´Ú©ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 2"},
 {code:"0013322214",name:"Ø²Ù‡Ø±Ø§ Ø¨Ø§Ø¨Ø§ÛŒÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 2"},
 {code:"0076209441",name:"Ù…Ø­Ù…Ø¯ Ù¾ÙˆØ±ÛŒØ§Ù†ÙØ±",section:"Ø·Ø¨Ù‚Ù‡ 2"},
 {code:"0013227173",name:"Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† ØµØ§Ø¯Ù‚ Ù†Ú˜Ø§Ø¯",section:"Ø·Ø¨Ù‚Ù‡ 2"},
 {code:"0014880751",name:"Ø­Ø³Ø§Ù… ÙÙ„Ø§Ø­Øª Ù¾ÛŒØ´Ù‡",section:"Ø·Ø¨Ù‚Ù‡ 2"},
 {code:"1360830634",name:"Ù…Ù‡Ø±Ø¯Ø§Ø¯ ØµØ§Ø¨Ø± Ù‚Ø±Ù‡ Ø¨Ø§Ø¨Ø§",section:"Ø·Ø¨Ù‚Ù‡ 2"},
 {code:"4232135855",name:"Ù…Ø­Ù…Ø¯ ØµÛŒØ§Ø¯ÛŒ Ø³ÛŒ Ø³Ø®Øª",section:"Ø·Ø¨Ù‚Ù‡ 2"},
 {code:"2980435430",name:"ÙØ§Ø¦Ø²Ù‡ Ø¨Ø§Ù‚Ø±ÛŒ Ù¾ÙˆØ±",section:"Ø·Ø¨Ù‚Ù‡ 2"},
 {code:"1465352864",name:"Ø±ÙˆØ´Ù†Ú© Ù…Ø­Ù…Ø¯ÛŒØ§Ù†",section:"Ø·Ø¨Ù‚Ù‡ 2"},
 {code:"0451327926",name:"Ù„ÛŒÙ„Ø§ Ø§Ø­Ù…Ø¯ÛŒ Ø¢ÙˆØ±Ø²Ù…Ø§Ù†",section:"Ø·Ø¨Ù‚Ù‡ 3"},
 {code:"0310669081",name:"Ù…Ø±ØªØ¶ÛŒ Ù†ÛŒÚ©ÙˆØ¦ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 1"},
 {code:"0084697377",name:"Ù…Ø±ØªØ¶ÛŒ Ø´Ø§Ù‡ Ù…Ø­Ù…Ø¯ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 1"},
 {code:"4560132534",name:"Ù¾Ø¯Ø±Ø§Ù… Ø¹Ø¨Ø¯Ø§Ù„Ù‡ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 1"},
 {code:"2471739113",name:"Ø¹Ø§Ø·ÙÙ‡ Ø³Ø±Ù…Ø¯",section:"Ø·Ø¨Ù‚Ù‡ 1"},
 {code:"0071114671",name:"Ø¹Ø±ÙØ§Ù†Ù‡ Ø³Ø§Ø¯Ø§Øª ÛŒØ²Ø¯Ø§Ù†Ø´Ù†Ø§Ø³",section:"Ø·Ø¨Ù‚Ù‡ 1"},
 {code:"0058084411",name:"ÛŒØ¹Ù‚ÙˆØ¨ Ø±Ø­ÛŒÙ…ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 1"},
 {code:"2050322747",name:"Ø¹Ù„ÛŒØ±Ø¶Ø§ Ø´Ú©Ø± Ø§Ù„Ù‡ Ù†ÛŒØ§ Ø±ÙˆØ´Ù†",section:"Ø·Ø¨Ù‚Ù‡ 1"},
 {code:"0018553771",name:"ØµØ¯Ù Ø¹Ù„ÛŒ Ù†Ú˜Ø§Ø¯",section:"Ø·Ø¨Ù‚Ù‡ 1"},
 {code:"2080284665",name:"Ø·Ù‡ Ø¨Ø§Ù„Ø§ÛŒÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 1"},
 {code:"0019294638",name:"Ù¾Ú¯Ø§Ù‡ Ú©Ø±ÛŒÙ…ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 0"},
 {code:"1742478638",name:"Ù„ÛŒÙ„Ø§ Ù…Ù†ÛŒØ´ Ø¯Ø§ÙˆÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 0"},
 {code:"4592243331",name:"Ø±Ø¶Ø§ Ø¯Ø§ÙˆØ±Ù¾Ù†Ø§Ù‡",section:"Ø·Ø¨Ù‚Ù‡ 0"},
 {code:"0059433876",name:"Ø¯Ø§ÙˆØ¯ Ø¯Ù„Ø§ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ø§",section:"Ø·Ø¨Ù‚Ù‡ 0"},
 {code:"0025204599",name:"Ø¹Ù„ÛŒ Ø§Ø³Ú©Ù†Ø¯Ø±ÛŒ Ù†ØµÙÚ†ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 3"},
 {code:"0011911131",name:"Ù…Ø­Ù…Ø¯ ØµØ§Ø¯Ù‚ Ø±ÙÛŒØ¹ Ù¾ÙˆÛŒØ§",section:"Ø·Ø¨Ù‚Ù‡ 3"},
 {code:"0682486401",name:"Ú©Ø§ÙˆÙ‡ Ø±Ø¬Ø¨ Ù¾ÙˆØ± Ù…Ù‚Ø¯Ù…",section:"Ø·Ø¨Ù‚Ù‡ 2"},
 {code:"0023475919",name:"Ø²Ù‡Ø±Ø§ ÙÛŒÙ„Ø³ÙˆÙÛŒØ§Ù†",section:"Ø·Ø¨Ù‚Ù‡ 1"},
 {code:"5669148134",name:"Ø­Ù‚ÛŒÙ‚Øª Ù†ÙˆØ±ÙˆØ²ÛŒ",section:"Ø·Ø¨Ù‚Ù‡ 2"},
];

/* Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±ÛŒ */
const DAYS = ["Ø´Ù†Ø¨Ù‡","ÛŒÚ©Ø´Ù†Ø¨Ù‡","Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡"];

/* Ù…Ù†ÙˆÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÛŒØ§ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ */
let weeklyMenu = JSON.parse(localStorage.getItem("weeklyMenu")) || {
  "Ø´Ù†Ø¨Ù‡":   {Ø®ÙˆØ±Ø§Ú©:"Ú©ØªÙ„Øª",           Ú©Ø¨Ø§Ø¨ÛŒ:"Ú†Ù„ÙˆÚ©Ø¨Ø§Ø¨",      Ø®ÙˆØ±Ø´ØªÛŒ:"Ù‚ÙˆØ±Ù…Ù‡â€ŒØ³Ø¨Ø²ÛŒ"},
  "ÛŒÚ©Ø´Ù†Ø¨Ù‡": {Ø®ÙˆØ±Ø§Ú©:"Ø®ÙˆØ±Ø§Ú© Ù…Ø±Øº",      Ú©Ø¨Ø§Ø¨ÛŒ:"Ú©Ø¨Ø§Ø¨ Ú©ÙˆØ¨ÛŒØ¯Ù‡",  Ø®ÙˆØ±Ø´ØªÛŒ:"Ù‚ÛŒÙ…Ù‡"},
  "Ø¯ÙˆØ´Ù†Ø¨Ù‡": {Ø®ÙˆØ±Ø§Ú©:"Ø¬ÙˆØ¬Ù‡â€ŒÚ†ÛŒÙ†ÛŒ",      Ú©Ø¨Ø§Ø¨ÛŒ:"Ú©Ø¨Ø§Ø¨ Ø³Ù„Ø·Ø§Ù†ÛŒ",  Ø®ÙˆØ±Ø´ØªÛŒ:"ÙØ³Ù†Ø¬ÙˆÙ†"},
  "Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡":{Ø®ÙˆØ±Ø§Ú©:"Ø®ÙˆØ±Ø§Ú© Ø³Ø¨Ø²ÛŒØ¬Ø§Øª",  Ú©Ø¨Ø§Ø¨ÛŒ:"Ø¬ÙˆØ¬Ù‡ Ú©Ø¨Ø§Ø¨",    Ø®ÙˆØ±Ø´ØªÛŒ:"Ø®ÙˆØ±Ø´ Ú©Ø±ÙØ³"},
  "Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡":{Ø®ÙˆØ±Ø§Ú©:"Ø§Ù…Ù„Øª",          Ú©Ø¨Ø§Ø¨ÛŒ:"Ú©Ø¨Ø§Ø¨ Ø¨Ø±Ú¯",     Ø®ÙˆØ±Ø´ØªÛŒ:"Ø®ÙˆØ±Ø´ Ø¨Ø§Ù…ÛŒÙ‡"}
};
/* Ú©Ù†Ø§Ø± ØºØ°Ø§Ù‡Ø§ */
let sideItems = JSON.parse(localStorage.getItem("sideItems")) || ["Ù†ÙˆØ´Ø§Ø¨Ù‡","Ø¯ÙˆØº","Ø³Ø§Ù„Ø§Ø¯ ÙØµÙ„"];

/* ===== ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø¬Ù„Ø§Ù„ÛŒ (Ø´Ù…Ø³ÛŒ) ===== */
function toJalali(gY,gM,gD){
  const gDaysInMonth=[31,28,31,30,31,30,31,31,30,31,30,31];
  const jDaysInMonth=[31,31,31,31,31,31,30,30,30,30,30,29];
  let gy=gY-1600, gm=gM-1, gd=gD-1;
  let gDayNo=365*gy+Math.floor((gy+3)/4)-Math.floor((gy+99)/100)+Math.floor((gy+399)/400);
  for(let i=0;i<gm;++i) gDayNo+=gDaysInMonth[i];
  if(gm>1 && ((gY%4===0 && gY%100!==0) || (gY%400===0))) gDayNo++;
  gDayNo+=gd;
  let jDayNo=gDayNo-79;
  let jNp=Math.floor(jDayNo/12053); jDayNo%=12053;
  let jy=979+33*jNp+4*Math.floor(jDayNo/1461); jDayNo%=1461;
  if(jDayNo>=366){ jy+=Math.floor((jDayNo-366)/365); jDayNo=(jDayNo-366)%365; }
  let jm=0; for(; jm<11 && jDayNo>=jDaysInMonth[jm]; ++jm) jDayNo-=jDaysInMonth[jm];
  let jd=jDayNo+1;
  return {jy, jm:jm+1, jd};
}
function jalaliWeekdayName(dateObj=new Date()){
  const map = ["ÛŒÚ©Ø´Ù†Ø¨Ù‡","Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡","Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡","Ø¬Ù…Ø¹Ù‡","Ø´Ù†Ø¨Ù‡"]; // JS: 0=Sun
  return map[dateObj.getDay()];
}
function formatJalali(dateObj=new Date()){
  const gy=dateObj.getFullYear(), gm=dateObj.getMonth()+1, gd=dateObj.getDate();
  const j=toJalali(gy,gm,gd);
  const wd=jalaliWeekdayName(dateObj);
  const pad=(n)=>String(n).padStart(2,"0");
  return {text:`${j.jy}/${pad(j.jm)}/${pad(j.jd)} - ${wd}`, weekday: wd};
}
function showTodayBarAndHighlight(){
  const t = formatJalali();
  document.getElementById("todayBar").textContent = `Ø§Ù…Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ): ${t.text}`;
  window.__todayJalaliWeekday = DAYS.includes(t.weekday) ? t.weekday : null;
}

/* ===== ÙˆØ±ÙˆØ¯ / Ø®Ø±ÙˆØ¬ ===== */
function login(){
  const code = document.getElementById("userCode").value.trim();
  const user = users.find(u=>u.code===code);

  if(code==="admin"){
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("adminDiv").style.display="block";
    document.getElementById("whoAmI").textContent="Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…";
    renderMenuEditor();
    renderOrdersTable();
    return;
  }
  if(user){
    localStorage.setItem("currentUser", user.code);
    localStorage.setItem("currentUserName", user.name);
    localStorage.setItem("currentUserSection", user.section);
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("orderDiv").style.display="block";
    document.getElementById("helloText").textContent = `Ø³Ù„Ø§Ù… ${user.name} (${user.section})`;
    document.getElementById("whoAmI").textContent = `${user.name} â€¢ ${user.section}`;
    renderOrderForm();
  } else {
    document.getElementById("loginMsg").textContent = "Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª!";
  }
}
function logout(){
  document.getElementById("orderDiv").style.display="none";
  document.getElementById("adminDiv").style.display="none";
  document.getElementById("loginDiv").style.display="block";
  document.getElementById("whoAmI").textContent="";
}

/* ===== ÙØ±Ù… Ø³ÙØ§Ø±Ø´ Ú©Ø§Ø±Ø¨Ø± ===== */
function renderOrderForm(){
  const container = document.getElementById("daysContainer");
  container.innerHTML = "";
  DAYS.forEach(day=>{
    const d = weeklyMenu[day];
    const wrap = document.createElement("div");
    wrap.className = "row";
    wrap.innerHTML = `
      <div class="grid-day">
        <div class="badge" data-day="${day}">${day}</div>
        <select id="meal_${day}" class="select">
          <option value="${d.Ø®ÙˆØ±Ø§Ú©}">${d.Ø®ÙˆØ±Ø§Ú©} (Ø®ÙˆØ±Ø§Ú©)</option>
          <option value="${d.Ú©Ø¨Ø§Ø¨ÛŒ}">${d.Ú©Ø¨Ø§Ø¨ÛŒ} (Ú©Ø¨Ø§Ø¨ÛŒ)</option>
          <option value="${d.Ø®ÙˆØ±Ø´ØªÛŒ}">${d.Ø®ÙˆØ±Ø´ØªÛŒ} (Ø®ÙˆØ±Ø´ØªÛŒ)</option>
        </select>
        <select id="side_${day}" class="select">
          ${sideItems.map(s=>`<option value="${s}">${s}</option>`).join("")}
        </select>
      </div>`;
    container.appendChild(wrap);
  });
  // Ù‡Ø§ÛŒÙ„Ø§ÛŒØª badge Ø±ÙˆØ² Ø¬Ø§Ø±ÛŒ (Ø´Ù…Ø³ÛŒ)
  if(window.__todayJalaliWeekday){
    const badge = document.querySelector(`.badge[data-day="${window.__todayJalaliWeekday}"]`);
    if(badge) badge.classList.add("today-ring");
  }
}

/* ===== Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ ===== */
function submitOrder(){
  const order = {};
  DAYS.forEach(day=>{
    order[day] = {
      meal: document.getElementById("meal_"+day).value,
      side: document.getElementById("side_"+day).value
    };
  });
  const userCode = localStorage.getItem("currentUser");
  const section  = localStorage.getItem("currentUserSection");
  localStorage.setItem("order_"+userCode, JSON.stringify({...order, section}));
  document.getElementById("orderMsg").textContent = "Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯!";
}

/* ===== Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±: Ø§Ø¯ÛŒØª Ù…Ù†Ùˆ Ùˆ Ú©Ù†Ø§Ø± ØºØ°Ø§ ===== */
function renderMenuEditor(){
  const box = document.getElementById("menuEditor");
  box.innerHTML = "";

  // Ú©Ù†Ø§Ø± ØºØ°Ø§Ù‡Ø§
  const sideCard = document.createElement("div");
  sideCard.className = "section";
  sideCard.innerHTML = `
    <h3>Ú©Ù†Ø§Ø± ØºØ°Ø§Ù‡Ø§</h3>
    <textarea id="sidesInput" rows="2" placeholder="Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯">${sideItems.join(", ")}</textarea>
    <small class="muted">Ù…Ø«Ø§Ù„: Ù†ÙˆØ´Ø§Ø¨Ù‡, Ø¯ÙˆØº, Ø³Ø§Ù„Ø§Ø¯ ÙØµÙ„</small>
  `;
  box.appendChild(sideCard);

  // Ø±ÙˆØ²Ù‡Ø§
  const daysCard = document.createElement("div");
  daysCard.className = "section";
  let html = `<h3>Ù…Ù†ÙˆÛŒ Ù‡ÙØªÙ‡</h3>`;
  DAYS.forEach(day=>{
    const d = weeklyMenu[day];
    html += `
      <div style="margin:10px 0; padding:10px; border:1px dashed rgba(255,255,255,.15); border-radius:10px">
        <div class="badge" data-day="${day}" style="display:inline-block;min-width:120px">${day}</div>
        <div class="two-col" style="margin-top:10px">
          <div>
            <label>Ø®ÙˆØ±Ø§Ú©:</label>
            <input id="edit_${day}_Ø®ÙˆØ±Ø§Ú©" class="input" value="${d.Ø®ÙˆØ±Ø§Ú©}">
          </div>
          <div>
            <label>Ú©Ø¨Ø§Ø¨ÛŒ:</label>
            <input id="edit_${day}_Ú©Ø¨Ø§Ø¨ÛŒ" class="input" value="${d.Ú©Ø¨Ø§Ø¨ÛŒ}">
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Ø®ÙˆØ±Ø´ØªÛŒ:</label>
          <input id="edit_${day}_Ø®ÙˆØ±Ø´ØªÛŒ" class="input" value="${d.Ø®ÙˆØ±Ø´ØªÛŒ}">
        </div>
      </div>
    `;
  });
  daysCard.innerHTML = html;
  box.appendChild(daysCard);
}

function saveMenu(){
  // Ú©Ù†Ø§Ø± ØºØ°Ø§Ù‡Ø§
  sideItems = (document.getElementById("sidesInput").value || "")
                .split(",").map(s=>s.trim()).filter(Boolean);
  localStorage.setItem("sideItems", JSON.stringify(sideItems));

  // Ù…Ù†ÙˆÛŒ Ø±ÙˆØ²Ù‡Ø§
  DAYS.forEach(day=>{
    weeklyMenu[day] = {
      Ø®ÙˆØ±Ø§Ú©:  document.getElementById(`edit_${day}_Ø®ÙˆØ±Ø§Ú©`).value || weeklyMenu[day].Ø®ÙˆØ±Ø§Ú©,
      Ú©Ø¨Ø§Ø¨ÛŒ:  document.getElementById(`edit_${day}_Ú©Ø¨Ø§Ø¨ÛŒ`).value || weeklyMenu[day].Ú©Ø¨Ø§Ø¨ÛŒ,
      Ø®ÙˆØ±Ø´ØªÛŒ:document.getElementById(`edit_${day}_Ø®ÙˆØ±Ø´ØªÛŒ`).value || weeklyMenu[day].Ø®ÙˆØ±Ø´ØªÛŒ,
    };
  });
  localStorage.setItem("weeklyMenu", JSON.stringify(weeklyMenu));
  alert("Ù…Ù†ÙˆÛŒ Ù‡ÙØªÙ‡ Ùˆ Ú©Ù†Ø§Ø± ØºØ°Ø§Ù‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…");
  // Ø±ÙØ±Ø´ ÙØ±Ù… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø§Ø² Ø¨ÙˆØ¯Ù†
  if (document.getElementById("orderDiv").style.display === "block") {
    renderOrderForm();
  }
}

/* ===== Ø¬Ø¯ÙˆÙ„ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ± ===== */
function renderOrdersTable(){
  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = "";
  users.forEach(u=>{
    const data = JSON.parse(localStorage.getItem("order_"+u.code) || "{}");
    if(Object.keys(data).length===0) return;
    const tds = DAYS.map(d=>{
      const cell = data[d];
      return `<td>${cell ? `${cell.meal} + ${cell.side}` : ""}</td>`;
    }).join("");
    tbody.insertAdjacentHTML("beforeend",
      `<tr><td>${u.code}</td><td>${u.name}</td><td>${data.section||""}</td>${tds}</tr>`
    );
  });
}

/* ===== Ø§Ú©Ø³Ù„â€ŒÙ‡Ø§ ===== */
function exportExcelAll(){
  let wb = XLSX.utils.book_new();
  let wsData = [["Ú©Ø¯ Ù…Ù„ÛŒ","Ù†Ø§Ù…","Ø¨Ø®Ø´","Ø´Ù†Ø¨Ù‡","ÛŒÚ©Ø´Ù†Ø¨Ù‡","Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡"]];
  users.forEach(u=>{
    const data = JSON.parse(localStorage.getItem("order_"+u.code) || "{}");
    if(Object.keys(data).length===0) return;
    wsData.push([
      u.code, u.name, data.section||"",
      data["Ø´Ù†Ø¨Ù‡"]      ? `${data["Ø´Ù†Ø¨Ù‡"].meal} + ${data["Ø´Ù†Ø¨Ù‡"].side}` : "",
      data["ÛŒÚ©Ø´Ù†Ø¨Ù‡"]    ? `${data["ÛŒÚ©Ø´Ù†Ø¨Ù‡"].meal} + ${data["ÛŒÚ©Ø´Ù†Ø¨Ù‡"].side}` : "",
      data["Ø¯ÙˆØ´Ù†Ø¨Ù‡"]    ? `${data["Ø¯ÙˆØ´Ù†Ø¨Ù‡"].meal} + ${data["Ø¯ÙˆØ´Ù†Ø¨Ù‡"].side}` : "",
      data["Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡"]   ? `${data["Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡"].meal} + ${data["Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡"].side}` : "",
      data["Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡"]  ? `${data["Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡"].meal} + ${data["Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡"].side}` : ""
    ]);
  });
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Orders-All");
  XLSX.writeFile(wb, "orders_all.xlsx");
}

function exportExcelDailyByFloor(){
  let wb = XLSX.utils.book_new();
  DAYS.forEach(day=>{
    const floors = [...new Set(users.map(u=>u.section))].sort();
    floors.forEach(floor=>{
      let wsData = [["Ú©Ø¯ Ù…Ù„ÛŒ","Ù†Ø§Ù…","Ø¨Ø®Ø´", day]];
      users.forEach(u=>{
        if(u.section !== floor) return;
        const data = JSON.parse(localStorage.getItem("order_"+u.code) || "{}");
        if(Object.keys(data).length===0) return;
        const cell = data[day];
        wsData.push([u.code, u.name, floor, cell ? `${cell.meal} + ${cell.side}` : ""]);
      });
      if(wsData.length>1){
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, `${day}-${floor}`);
      }
    });
  });
  XLSX.writeFile(wb, "orders_daily_by_floor.xlsx");
}

/* Ø§Ù…Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ) Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø·Ø¨Ù‚Ù‡ */
function exportExcelTodayByFloorJalali(){
  const {weekday, text} = formatJalali(new Date());
  if(!DAYS.includes(weekday)){
    alert(`Ø§Ù…Ø±ÙˆØ² (${text}) Ø¬Ø² Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±ÛŒ ØªØ¹Ø±ÛŒÙâ€ŒØ´Ø¯Ù‡ Ù†ÛŒØ³Øª.`);
    return;
  }
  let wb = XLSX.utils.book_new();
  const day = weekday;
  const floors = [...new Set(users.map(u=>u.section))].sort();
  floors.forEach(floor=>{
    let wsData = [[`Ø§Ù…Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ): ${text}`],["Ú©Ø¯ Ù…Ù„ÛŒ","Ù†Ø§Ù…","Ø¨Ø®Ø´", day]];
    users.forEach(u=>{
      if(u.section !== floor) return;
      const data = JSON.parse(localStorage.getItem("order_"+u.code) || "{}");
      if(Object.keys(data).length===0) return;
      const cell = data[day];
      wsData.push([u.code, u.name, floor, cell ? `${cell.meal} + ${cell.side}` : ""]);
    });
    if(wsData.length>2){
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, `${day}-${floor}`);
    }
  });
  XLSX.writeFile(wb, `orders_today_${day}.xlsx`);
}

/* ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø¯ÙˆÙ„ ÙˆÙ‚ØªÛŒ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒ Ø¨Ù‡ ØªØ¨ */
document.addEventListener("visibilitychange", ()=>{
  if(document.visibilityState==="visible" && document.getElementById("adminDiv").style.display==="block"){
    renderOrdersTable();
  }
});

/* Ø¨ÙˆØª */
showTodayBarAndHighlight();
</script>

</body>
</html>
