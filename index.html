<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🍽️ سفارش غذای شرکت</title>
<style>
  body{margin:0;background:#0f172a;color:#e6edf6;font-family:Tahoma,system-ui;line-height:1.7}
  header{position:sticky;top:0;z-index:10;background:#1e293b;padding:14px;text-align:center;border-bottom:1px solid #334155}
  .container{max-width:1100px;margin:24px auto;padding:0 18px}
  .card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:20px;margin-bottom:18px}
  h2,h3{margin:6px 0 14px}
  input,select,button{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e6edf6;font-size:15px}
  button{cursor:pointer;font-weight:800;background:linear-gradient(180deg,#22c55e,#16a34a);border:none}
  button:hover{filter:brightness(1.05)}
  .danger{background:linear-gradient(180deg,#ef4444,#b91c1c)!important}
  .grid-day{display:grid;gap:12px;grid-template-columns:220px 1fr 1fr}
  @media (max-width:800px){.grid-day{grid-template-columns:1fr}}
  .badge{padding:12px;border-radius:12px;font-weight:800;text-align:center;color:#fff;border:1px solid #334155}
  .badge[data-day="شنبه"]{background:#ef4444}
  .badge[data-day="یکشنبه"]{background:#f59e0b}
  .badge[data-day="دوشنبه"]{background:#10b981}
  .badge[data-day="سه‌شنبه"]{background:#3b82f6}
  .badge[data-day="چهارشنبه"]{background:#8b5cf6}
  .badge.off{background:#64748b;text-decoration:line-through}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #334155;padding:8px;text-align:center;font-size:13px}
  thead{background:#334155}
  .note{font-size:13px;color:#93c5fd;margin-top:6px}
  .btn-row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  @media (max-width:700px){.btn-row{grid-template-columns:1fr}}
</style>
</head>
<body>

<header>
  <h2>🍽️ سفارش غذای شرکت</h2>
  <div id="whoAmI"></div>
  <div id="menuStatus" class="note">در حال بارگذاری منو…</div>
</header>

<div class="container">
  <!-- ورود -->
  <div class="card" id="loginDiv">
    <h3>ورود</h3>
    <p class="note">کد ملی خود را وارد کنید. (برای مدیر: <b>admin</b>)</p>
    <input id="userCode" placeholder="کد ملی" />
    <button onclick="login()">ورود</button>
    <p id="loginMsg" style="color:#f87171"></p>
  </div>

  <!-- انتخاب -->
  <div class="card" id="orderDiv" style="display:none;">
    <h3>انتخاب غذا و کنارغذا (۸ تا ۲۱ شهریور)</h3>
    <p id="helloText" class="note"></p>
    <div id="holidayBar" class="note" style="display:none"></div>
    <div id="weeklyContainer"></div>
    <div class="btn-row" style="margin-top:12px">
      <button onclick="submitOrder()">ثبت سفارش</button>
      <button class="danger" onclick="logout()">بازگشت</button>
    </div>
    <p id="orderMsg" style="color:#34d399"></p>
  </div>

  <!-- ادمین -->
  <div class="card" id="adminDiv" style="display:none;">
    <h3>پنل مدیر</h3>
    <div class="note" id="rangeNote">بازه: ۱۴۰۴/۰۶/۰۸ تا ۱۴۰۴/۰۶/۲۱</div>

    <div class="btn-row" style="margin:10px 0">
      <button onclick="loadSheet()">📥 خواندن سفارش‌ها از گوگل‌شیت</button>
      <button class="danger" onclick="logout()">خروج</button>
    </div>

    <div class="btn-row" style="margin:10px 0">
      <button onclick="exportWeekCSVFromSheet()">⬇️ دانلود CSV هفتگی</button>
      <button onclick="exportDailyByFloorCSVFromSheet()">⬇️ دانلود CSV روزانه به تفکیک طبقه</button>
    </div>

    <table id="ordersTable">
      <thead>
        <tr><th>کد ملی</th><th>نام</th><th>بخش</th><th>تاریخ</th><th>روز</th><th>غذا</th><th>کنارغذا</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ===== لینک‌ها ===== */
// Google Script شما (ثابت همونی که دادی)
const SHEET_URL = "https://script.google.com/macros/s/AKfycbx_XfF012kwWwffB0icbT4o2Xxa-Zm_ZSDjyVVcoqJiN7GrR9LMQag23Lp_grU4ajx5jw/exec";
// آدرس قطعی menu.json روی GitHub Pages (اگر اسم ریپو فرق دارد، این را تغییر بده)
const MENU_URL  = "https://alieskandari4599.github.io/company-food-order/menu.json";

/* ===== کارکنان (کامل) ===== */
const users = [
 {"code":"1465316159","name":"علی اصغرزاده صادق","section":"طبقه 4"},
 {"code":"0939825902","name":"سید علی میرتونی","section":"طبقه 4"},
 {"code":"0075102110","name":"محسن اشرف اسلامی","section":"طبقه 4"},
 {"code":"1532626142","name":"زهرا محمدی حلمسلوئی","section":"طبقه 4"},
 {"code":"2710033445","name":"مسعود قاسم زاده سیاهکل","section":"طبقه 3"},
 {"code":"1263594301","name":"مهدی نوروزی خزاقی","section":"طبقه 3"},
 {"code":"0010275975","name":"لیلا رسولی درآباد","section":"طبقه 3"},
 {"code":"0014668688","name":"محمدرضا عبدالهی","section":"طبقه 3"},
 {"code":"0051385090","name":"شاهین فاضل مهر","section":"طبقه 3"},
 {"code":"1450551394","name":"فاطمه پارسای","section":"طبقه 3"},
 {"code":"1263591310","name":"مقداد شفقی","section":"طبقه 3"},
 {"code":"0020090641","name":"فاطمه میرزاخانی","section":"طبقه 3"},
 {"code":"0077320980","name":"جواد مرادپور","section":"طبقه 1"},
 {"code":"0082878110","name":"الناز نوروزی","section":"طبقه 2"},
 {"code":"5449975856","name":"ولی اله غنجی فشکی","section":"طبقه 2"},
 {"code":"0013322214","name":"زهرا بابایی","section":"طبقه 2"},
 {"code":"0076209441","name":"محمد پوریانفر","section":"طبقه 2"},
 {"code":"0013227173","name":"امیرحسین صادق نژاد","section":"طبقه 2"},
 {"code":"0014880751","name":"حسام فلاحت پیشه","section":"طبقه 2"},
 {"code":"1360830634","name":"مهرداد صابر قره بابا","section":"طبقه 2"},
 {"code":"4232135855","name":"محمد صیادی سی سخت","section":"طبقه 2"},
 {"code":"2980435430","name":"فائزه باقری پور","section":"طبقه 2"},
 {"code":"1465352864","name":"روشنک محمدیان","section":"طبقه 2"},
 {"code":"0451327926","name":"لیلا احمدی آورزمان","section":"طبقه 3"},
 {"code":"0310669081","name":"مرتضی نیکوئی","section":"طبقه 1"},
 {"code":"0084697377","name":"مرتضی شاه محمدی","section":"طبقه 1"},
 {"code":"4560132534","name":"پدرام عبدالهی","section":"طبقه 1"},
 {"code":"2471739113","name":"عاطفه سرمد","section":"طبقه 1"},
 {"code":"0071114671","name":"عرفانه سادات یزدانشناس","section":"طبقه 1"},
 {"code":"0058084411","name":"یعقوب رحیمی","section":"طبقه 1"},
 {"code":"2050322747","name":"علیرضا شکر اله نیا روشن","section":"طبقه 1"},
 {"code":"0018553771","name":"صدف علی نژاد","section":"طبقه 1"},
 {"code":"2080284665","name":"طه بالایی","section":"طبقه 1"},
 {"code":"0019294638","name":"پگاه کریمی","section":"طبقه 0"},
 {"code":"1742478638","name":"لیلا منیش داوی","section":"طبقه 0"},
 {"code":"4592243331","name":"رضا داورپناه","section":"طبقه 0"},
 {"code":"0059433876","name":"داود دلاوری پارسا","section":"طبقه 0"},
 {"code":"0025204599","name":"علی اسکندری نصفچی","section":"طبقه 3"},
 {"code":"0011911131","name":"محمد صادق رفیع پویا","section":"طبقه 3"},
 {"code":"0682486401","name":"کاوه رجب پور مقدم","section":"طبقه 2"},
 {"code":"0023475919","name":"زهرا فیلسوفیان","section":"طبقه 1"},
 {"code":"5669148134","name":"حقیقت نوروزی","section":"طبقه 2"}
];

/* ===== داده‌های منو ===== */
let menuDays = [];   // [{jdate, weekday, off, menu:{نوع1,نوع2,نوع3}}]
let sides    = [];   // ["نوشابه",...]

/* ===== ورود/خروج ===== */
function login(){
  const code=document.getElementById("userCode").value.trim();
  if(code==="admin"){
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("adminDiv").style.display="block";
    document.getElementById("whoAmI").textContent="مدیر سیستم";
    return;
  }
  const u=users.find(x=>x.code===code);
  if(!u){ document.getElementById("loginMsg").textContent="کد ملی معتبر نیست!"; return; }
  localStorage.setItem("currentUser",JSON.stringify(u));
  document.getElementById("loginDiv").style.display="none";
  document.getElementById("orderDiv").style.display="block";
  document.getElementById("helloText").textContent=`سلام ${u.name} (${u.section})`;
  document.getElementById("whoAmI").textContent=`${u.name} • ${u.section}`;
  renderWeeklyForm();
}
function logout(){
  document.getElementById("loginDiv").style.display="block";
  document.getElementById("orderDiv").style.display="none";
  document.getElementById("adminDiv").style.display="none";
  document.getElementById("whoAmI").textContent="";
}

/* ===== لود منو (ضدکش و ضدخطا) ===== */
async function loadMenu(){
  const status = document.getElementById("menuStatus");
  try{
    const res = await fetch(MENU_URL + "?v=" + Date.now(), {cache:"no-store"});
    if(!res.ok){ throw new Error("HTTP " + res.status); }
    const data = await res.json();

    const rawDays  = Array.isArray(data.days)  ? data.days  : [];
    const rawSides = Array.isArray(data.sides) ? data.sides : [];
    sides = rawSides.length ? rawSides : ["نوشابه","دوغ","ماست","سالاد"];

    menuDays = rawDays.map(d => {
      const off = d.off === true;
      const menu = (d.menu && typeof d.menu === "object") ? d.menu : {};
      return {
        jdate: d.jdate || "",
        weekday: d.weekday || "",
        off,
        menu: off ? { "نوع1":"", "نوع2":"", "نوع3":"" } : {
          "نوع1": String(menu["نوع1"] || ""),
          "نوع2": String(menu["نوع2"] || ""),
          "نوع3": String(menu["نوع3"] || "")
        }
      };
    });

    // نگه‌داشتن فقط ۸ تا ۲۱ شهریور
    menuDays = menuDays.filter(d => /^1404\/06\/(0?8|09|1[0-9]|20|21)$/.test(d.jdate));

    status.textContent = "منو بارگذاری شد ✅";
    renderWeeklyForm();
  }catch(err){
    console.error("loadMenu error:", err);
    status.textContent = "خطا در بارگذاری منو: " + (err.message || err);
  }
}

/* ===== ساخت فرم از menu.json ===== */
function renderWeeklyForm(){
  const box=document.getElementById("weeklyContainer");
  const hol=document.getElementById("holidayBar");
  box.innerHTML="";

  if(!Array.isArray(menuDays) || menuDays.length===0){
    box.innerHTML = '<div style="color:#f87171">منو خالی است یا درست بارگذاری نشده.</div>';
    return;
  }

  const offs = menuDays.filter(d=>d.off);
  if(offs.length){
    hol.style.display="block";
    hol.textContent = "تعطیلی‌ها: " + offs.map(o=>`${o.jdate} (${o.weekday})`).join(" ، ");
  } else {
    hol.style.display="none";
  }

  menuDays.forEach(d=>{
    if(d.off){
      box.insertAdjacentHTML("beforeend",
        `<div class="grid-day">
           <div class="badge off">${d.weekday} (${d.jdate})</div>
           <div style="grid-column:span 2;color:#94a3b8;">تعطیل</div>
         </div>`);
      return;
    }
    const n1 = d.menu["نوع1"] || "";
    const n2 = d.menu["نوع2"] || "";
    const n3 = d.menu["نوع3"] || "";
    box.insertAdjacentHTML("beforeend",`
      <div class="grid-day">
        <div class="badge" data-day="${d.weekday}">${d.weekday} (${d.jdate})</div>
        <select id="meal_${d.jdate}">
          ${[n1,n2,n3].map(v=>`<option>${v}</option>`).join("")}
        </select>
        <select id="side_${d.jdate}">
          ${sides.map(s=>`<option>${s}</option>`).join("")}
        </select>
      </div>
    `);
  });
}

/* ===== ثبت سفارش → Google Sheet ===== */
async function submitOrder(){
  const u=JSON.parse(localStorage.getItem("currentUser")||"null");
  if(!u){ alert("ابتدا وارد شوید."); return; }

  for(const d of menuDays){
    if(d.off) continue;
    const meal=document.getElementById(`meal_${d.jdate}`).value;
    const side=document.getElementById(`side_${d.jdate}`).value;
    try{
      await fetch(SHEET_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({code:u.code,name:u.name,section:u.section,jdate:d.jdate,weekday:d.weekday,meal,side})
      });
    }catch(e){ console.warn("POST failed for", d.jdate, e); }
  }
  document.getElementById("orderMsg").textContent="سفارش شما ثبت شد ✅";
}

/* ===== پنل مدیر: خواندن از شیت + CSV ===== */
async function loadSheet(){
  const res=await fetch(SHEET_URL, {cache:"no-store"});
  const data=await res.json(); // [{code,name,section,jdate,weekday,meal,side}]
  const tbody=document.querySelector("#ordersTable tbody");
  tbody.innerHTML="";
  data.forEach(r=>{
    tbody.insertAdjacentHTML("beforeend",
      `<tr><td>${r.code}</td><td>${r.name}</td><td>${r.section}</td>
           <td>${r.jdate}</td><td>${r.weekday}</td><td>${r.meal}</td><td>${r.side}</td></tr>`);
  });
}
function downloadCSV(text, filename){
  const blob = new Blob(["\uFEFF"+text], {type:"text/csv;charset=utf-8"});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 0);
}
function normalize(str){ return (str||"").toString().replace(/[\r\n]+/g," ").replace(/,/g,"،"); }
async function getAllOrders(){ const r=await fetch(SHEET_URL, {cache:"no-store"}); return await r.json(); }

/* CSV هفتگی: ستون‌ها = روزهای کاری غیرتعطیل منو */
async function exportWeekCSVFromSheet(){
  const data = await getAllOrders();
  const daysWorking = menuDays.filter(d=>!d.off).map(d=>({key:d.jdate, label:`${d.jdate} (${d.weekday})`}));
  let header = ["کد ملی","نام","بخش", ...daysWorking.map(d=>d.label)];
  let rows = [header];

  const byCode = {};
  data.forEach(r=>{
    if(!byCode[r.code]) byCode[r.code] = {code:r.code, name:r.name, section:r.section, days:{}};
    byCode[r.code].days[r.jdate] = `${normalize(r.meal)} + ${normalize(r.side)}`;
  });

  Object.values(byCode).forEach(p=>{
    const line = [p.code, normalize(p.name), normalize(p.section)];
    daysWorking.forEach(d=> line.push(normalize(p.days[d.key]||"")) );
    rows.push(line);
  });

  const csv = rows.map(r=>r.join(",")).join("\n");
  downloadCSV(csv, "orders_weekly_1404-06-08_to_1404-06-21.csv");
}

/* CSV روزانه به تفکیک طبقه: برای هر روز غیرتعطیل یک فایل جدا */
async function exportDailyByFloorCSVFromSheet(){
  const data = await getAllOrders();
  const floors = [...new Set(users.map(u=>u.section))];
  for(const d of menuDays){
    if(d.off) continue;
    const parts = [];
    floors.forEach(floor=>{
      let block = [`طبقه: ${floor}`, "کد ملی,نام,بخش,سفارش"];
      data.filter(r=>r.jdate===d.jdate && r.section===floor).forEach(r=>{
        block.push([r.code, normalize(r.name), normalize(r.section), `${normalize(r.meal)} + ${normalize(r.side)}`].join(","));
      });
      parts.push(block.join("\n"));
    });
    downloadCSV(parts.join("\n\n"), `orders_${d.jdate.replaceAll("/","-")}_by_floor.csv`);
  }
}

/* بوت */
loadMenu();
</script>
</body>
</html>