<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø³ÙØ§Ø±Ø´ ØºØ°Ø§ÛŒ Ø´Ø±Ú©Øª</title>
<style>
  :root{
    --bg:#0f172a; --card:rgba(255,255,255,.08); --card-border:rgba(255,255,255,.18);
    --text:#e6edf6; --muted:#b6c2d9; --accent:#22c55e; --accent-strong:#16a34a;
    --danger:#ef4444; --ok:#34d399; --shadow:0 10px 30px rgba(0,0,0,.25); --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tahoma,system-ui;background:var(--bg);color:var(--text);line-height:1.7;}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);
    background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(15,23,42,.75));
    border-bottom:1px solid rgba(255,255,255,.08);}
  .nav{max-width:1100px;margin:auto;padding:16px 20px;display:flex;justify-content:space-between;align-items:center}
  .brand{font-weight:800;font-size:20px}
  #whoAmI{color:var(--muted);font-size:14px}
  .container{max-width:1100px;margin:28px auto;padding:0 18px}
  .card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;margin-bottom:20px;text-align:center}
  h2{margin:6px 0 16px}
  .muted{color:var(--muted)}
  .input,.select,.button{
    width:100%;padding:12px 14px;font-size:16px;border-radius:12px;border:1px solid var(--card-border);
    background:rgba(255,255,255,.07);color:var(--text);outline:none
  }
  .button{cursor:pointer;font-weight:800;background:linear-gradient(180deg,var(--accent),var(--accent-strong));border:none}
  .button:hover{filter:brightness(1.05)}
  .danger{background:linear-gradient(180deg,var(--danger),#b91c1c)!important}
  .row{display:grid;gap:12px}
  .grid-day{display:grid;gap:12px;grid-template-columns:260px 1fr 1fr}
  @media (max-width:820px){.grid-day{grid-template-columns:1fr}}
  .badge{
    padding:12px;border-radius:12px;font-weight:800;text-align:center;color:#fff;border:1px solid var(--card-border)
  }
  .badge[data-wd="Ø´Ù†Ø¨Ù‡"]{background:#ef4444}
  .badge[data-wd="ÛŒÚ©Ø´Ù†Ø¨Ù‡"]{background:#f59e0b}
  .badge[data-wd="Ø¯ÙˆØ´Ù†Ø¨Ù‡"]{background:#10b981}
  .badge[data-wd="Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡"]{background:#3b82f6}
  .badge[data-wd="Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡"]{background:#8b5cf6}
  .badge.off{background:#64748b;text-decoration:line-through}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid rgba(255,255,255,.12);padding:8px;text-align:center;font-size:13px}
  thead{background:rgba(255,255,255,.1)}
  tbody tr:nth-child(odd){background:rgba(255,255,255,.04)}
  .topnote{font-size:13px;color:#93c5fd;margin-top:6px}
  .okdot{color:#22c55e;font-weight:900;margin-right:6px}
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="brand">ğŸ½ï¸ Ø³ÙØ§Ø±Ø´ ØºØ°Ø§ÛŒ Ø´Ø±Ú©Øª</div>
    <div id="whoAmI"></div>
  </div>
  <div id="menuStatus" class="topnote">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ù†Ùˆâ€¦</div>
</header>

<div class="container">
  <!-- ÙˆØ±ÙˆØ¯ -->
  <div class="card" id="loginDiv">
    <h2>ÙˆØ±ÙˆØ¯</h2>
    <p class="muted">Ú©Ø¯ Ù…Ù„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. </p>
    <div class="row">
      <input id="userCode" class="input"  />
      <button class="button" onclick="login()">ÙˆØ±ÙˆØ¯</button>
      <p id="loginMsg" style="color:#ff6b6b"></p>
    </div>
  </div>

  <!-- Ø§Ù†ØªØ®Ø§Ø¨ ØºØ°Ø§ (ØªÙ…Ø§Ù… Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¨Ø§Ø²Ù‡) -->
  <div class="card" id="orderDiv" style="display:none;">
    <h2 id="rangeTitle">Ø§Ù†ØªØ®Ø§Ø¨ ØºØ°Ø§ Ùˆ Ú©Ù†Ø§Ø±ØºØ°Ø§</h2>
    <p id="helloText" class="muted"></p>
    <div id="holidayBar" class="topnote" style="display:none"></div>

    <div id="daysContainer"></div>

    <div class="row" style="margin-top:12px;grid-template-columns:1fr 1fr">
      <button class="button" onclick="submitOrder()">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
      <button class="button danger" onclick="logout()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>
    <p id="orderMsg" style="color:#34d399"></p>
  </div>

  <!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± -->
  <div class="card" id="adminDiv" style="display:none;">
    <h2>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±</h2>
    <div class="row" style="grid-template-columns:1fr 1fr">
      <button class="button" onclick="exportWeekCSV()">ğŸ“¥ CSV Ù‡ÙØªÚ¯ÛŒ (Ú©Ù„ Ø¬Ø¯ÙˆÙ„)</button>
      <button class="button" onclick="exportDailyByFloorCSV()">ğŸ“¥ CSV Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø·Ø¨Ù‚Ù‡</button>
    </div>
    <div class="row" style="grid-template-columns:1fr 1fr; margin-top:10px">
      <div>
        <label class="muted">ÙÛŒÙ„ØªØ± Ø¨Ø®Ø´</label>
        <select id="sectionFilter" class="select" onchange="renderOrdersTable()">
          <option value="Ù‡Ù…Ù‡">Ù‡Ù…Ù‡</option>
        </select>
      </div>
      <div class="topnote" id="rangeNote"></div>
    </div>
    <table id="ordersTable">
      <thead>
        <tr>
          <th>Ú©Ø¯ Ù…Ù„ÛŒ</th><th>Ù†Ø§Ù…</th><th>Ø¨Ø®Ø´</th>
          <th>Ø´Ù†Ø¨Ù‡</th><th>ÛŒÚ©Ø´Ù†Ø¨Ù‡</th><th>Ø¯ÙˆØ´Ù†Ø¨Ù‡</th><th>Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</th><th>Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="row" style="margin-top:12px">
      <button class="button danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</div>

<script>
// ===== Ú©Ø§Ø±Ú©Ù†Ø§Ù† (Ú©Ø§Ù…Ù„) =====
const users = [
 {"code":"1465316159","name":"Ø¹Ù„ÛŒ Ø§ØµØºØ±Ø²Ø§Ø¯Ù‡ ØµØ§Ø¯Ù‚","section":"Ø·Ø¨Ù‚Ù‡ 4"},
 {"code":"0939825902","name":"Ø³ÛŒØ¯ Ø¹Ù„ÛŒ Ù…ÛŒØ±ØªÙˆÙ†ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 4"},
 {"code":"0075102110","name":"Ù…Ø­Ø³Ù† Ø§Ø´Ø±Ù Ø§Ø³Ù„Ø§Ù…ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 4"},
 {"code":"1532626142","name":"Ø²Ù‡Ø±Ø§ Ù…Ø­Ù…Ø¯ÛŒ Ø­Ù„Ù…Ø³Ù„ÙˆØ¦ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 4"},
 {"code":"2710033445","name":"Ù…Ø³Ø¹ÙˆØ¯ Ù‚Ø§Ø³Ù… Ø²Ø§Ø¯Ù‡ Ø³ÛŒØ§Ù‡Ú©Ù„","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"1263594301","name":"Ù…Ù‡Ø¯ÛŒ Ù†ÙˆØ±ÙˆØ²ÛŒ Ø®Ø²Ø§Ù‚ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0010275975","name":"Ù„ÛŒÙ„Ø§ Ø±Ø³ÙˆÙ„ÛŒ Ø¯Ø±Ø¢Ø¨Ø§Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0014668688","name":"Ù…Ø­Ù…Ø¯Ø±Ø¶Ø§ Ø¹Ø¨Ø¯Ø§Ù„Ù‡ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0051385090","name":"Ø´Ø§Ù‡ÛŒÙ† ÙØ§Ø¶Ù„ Ù…Ù‡Ø±","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"1450551394","name":"ÙØ§Ø·Ù…Ù‡ Ù¾Ø§Ø±Ø³Ø§ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"1263591310","name":"Ù…Ù‚Ø¯Ø§Ø¯ Ø´ÙÙ‚ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0020090641","name":"ÙØ§Ø·Ù…Ù‡ Ù…ÛŒØ±Ø²Ø§Ø®Ø§Ù†ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0077320980","name":"Ø¬ÙˆØ§Ø¯ Ù…Ø±Ø§Ø¯Ù¾ÙˆØ±","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0082878110","name":"Ø§Ù„Ù†Ø§Ø² Ù†ÙˆØ±ÙˆØ²ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"5449975856","name":"ÙˆÙ„ÛŒ Ø§Ù„Ù‡ ØºÙ†Ø¬ÛŒ ÙØ´Ú©ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0013322214","name":"Ø²Ù‡Ø±Ø§ Ø¨Ø§Ø¨Ø§ÛŒÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0076209441","name":"Ù…Ø­Ù…Ø¯ Ù¾ÙˆØ±ÛŒØ§Ù†ÙØ±","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0013227173","name":"Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† ØµØ§Ø¯Ù‚ Ù†Ú˜Ø§Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0014880751","name":"Ø­Ø³Ø§Ù… ÙÙ„Ø§Ø­Øª Ù¾ÛŒØ´Ù‡","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"1360830634","name":"Ù…Ù‡Ø±Ø¯Ø§Ø¯ ØµØ§Ø¨Ø± Ù‚Ø±Ù‡ Ø¨Ø§Ø¨Ø§","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"4232135855","name":"Ù…Ø­Ù…Ø¯ ØµÛŒØ§Ø¯ÛŒ Ø³ÛŒ Ø³Ø®Øª","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"2980435430","name":"ÙØ§Ø¦Ø²Ù‡ Ø¨Ø§Ù‚Ø±ÛŒ Ù¾ÙˆØ±","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"1465352864","name":"Ø±ÙˆØ´Ù†Ú© Ù…Ø­Ù…Ø¯ÛŒØ§Ù†","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0451327926","name":"Ù„ÛŒÙ„Ø§ Ø§Ø­Ù…Ø¯ÛŒ Ø¢ÙˆØ±Ø²Ù…Ø§Ù†","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0310669081","name":"Ù…Ø±ØªØ¶ÛŒ Ù†ÛŒÚ©ÙˆØ¦ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0084697377","name":"Ù…Ø±ØªØ¶ÛŒ Ø´Ø§Ù‡ Ù…Ø­Ù…Ø¯ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"4560132534","name":"Ù¾Ø¯Ø±Ø§Ù… Ø¹Ø¨Ø¯Ø§Ù„Ù‡ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"2471739113","name":"Ø¹Ø§Ø·ÙÙ‡ Ø³Ø±Ù…Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0071114671","name":"Ø¹Ø±ÙØ§Ù†Ù‡ Ø³Ø§Ø¯Ø§Øª ÛŒØ²Ø¯Ø§Ù†Ø´Ù†Ø§Ø³","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0058084411","name":"ÛŒØ¹Ù‚ÙˆØ¨ Ø±Ø­ÛŒÙ…ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"2050322747","name":"Ø¹Ù„ÛŒØ±Ø¶Ø§ Ø´Ú©Ø± Ø§Ù„Ù‡ Ù†ÛŒØ§ Ø±ÙˆØ´Ù†","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0018553771","name":"ØµØ¯Ù Ø¹Ù„ÛŒ Ù†Ú˜Ø§Ø¯","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"2080284665","name":"Ø·Ù‡ Ø¨Ø§Ù„Ø§ÛŒÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"0019294638","name":"Ù¾Ú¯Ø§Ù‡ Ú©Ø±ÛŒÙ…ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 0"},
 {"code":"1742478638","name":"Ù„ÛŒÙ„Ø§ Ù…Ù†ÛŒØ´ Ø¯Ø§ÙˆÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 0"},
 {"code":"4592243331","name":"Ø±Ø¶Ø§ Ø¯Ø§ÙˆØ±Ù¾Ù†Ø§Ù‡","section":"Ø·Ø¨Ù‚Ù‡ 0"},
 {"code":"0059433876","name":"Ø¯Ø§ÙˆØ¯ Ø¯Ù„Ø§ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ø§","section":"Ø·Ø¨Ù‚Ù‡ 0"},
 {"code":"0025204599","name":"Ø¹Ù„ÛŒ Ø§Ø³Ú©Ù†Ø¯Ø±ÛŒ Ù†ØµÙÚ†ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0011911131","name":"Ù…Ø­Ù…Ø¯ ØµØ§Ø¯Ù‚ Ø±ÙÛŒØ¹ Ù¾ÙˆÛŒØ§","section":"Ø·Ø¨Ù‚Ù‡ 3"},
 {"code":"0682486401","name":"Ú©Ø§ÙˆÙ‡ Ø±Ø¬Ø¨ Ù¾ÙˆØ± Ù…Ù‚Ø¯Ù…","section":"Ø·Ø¨Ù‚Ù‡ 2"},
 {"code":"0023475919","name":"Ø²Ù‡Ø±Ø§ ÙÛŒÙ„Ø³ÙˆÙÛŒØ§Ù†","section":"Ø·Ø¨Ù‚Ù‡ 1"},
 {"code":"5669148134","name":"Ø­Ù‚ÛŒÙ‚Øª Ù†ÙˆØ±ÙˆØ²ÛŒ","section":"Ø·Ø¨Ù‚Ù‡ 2"}
];

// ===== ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²Ù‡ Ùˆ Ù…Ù†Ùˆ =====
let MENU = null;      // Ú©Ù„ menu.json
let ACTIVE_DAYS = []; // ÙÙ‚Ø· Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±ÛŒ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡ (Ø¨Ø¯ÙˆÙ† ØªØ¹Ø·ÛŒÙ„)
let SIDES = [];       // Ú©Ù†Ø§Ø±ØºØ°Ø§
const WD_ORDER = ["Ø´Ù†Ø¨Ù‡","ÛŒÚ©Ø´Ù†Ø¨Ù‡","Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡"];

// ===== Ù„Ø§Ú¯ÛŒÙ†/Ø®Ø±ÙˆØ¬ =====
function login(){
  const code = document.getElementById('userCode').value.trim();
  if(code === 'admin'){
    document.getElementById('loginDiv').style.display='none';
    document.getElementById('adminDiv').style.display='block';
    document.getElementById('whoAmI').textContent='Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…';
    populateSectionFilter(); renderOrdersTable();
    return;
  }
  const u = users.find(x=>x.code===code);
  if(!u){ document.getElementById('loginMsg').textContent='Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª!'; return; }
  localStorage.setItem('currentUser',u.code);
  localStorage.setItem('currentUserName',u.name);
  localStorage.setItem('currentUserSection',u.section);
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('orderDiv').style.display='block';
  document.getElementById('helloText').textContent=`Ø³Ù„Ø§Ù… ${u.name} (${u.section})`;
  document.getElementById('whoAmI').textContent=`${u.name} â€¢ ${u.section}`;
  renderDaysForm();
}
function logout(){
  document.getElementById('orderDiv').style.display='none';
  document.getElementById('adminDiv').style.display='none';
  document.getElementById('loginDiv').style.display='block';
  document.getElementById('whoAmI').textContent='';
}

// ===== Ø³Ø§Ø®Øª ÙØ±Ù…Ù Ù‡Ù…Ù‡ Ø±ÙˆØ²Ù‡Ø§ Ø§Ø² menu.json =====
function renderDaysForm(){
  const box = document.getElementById('daysContainer');
  const holBar = document.getElementById('holidayBar');
  box.innerHTML='';

  // Ù†ÙˆØ§Ø± ØªØ¹Ø·ÛŒÙ„ÛŒâ€ŒÙ‡Ø§
  const offs = (MENU.days||[]).filter(d=>d.off);
  if(offs.length){
    holBar.style.display='block';
    holBar.innerHTML = `<span class="okdot">â– </span> ØªØ¹Ø·ÛŒÙ„ÛŒâ€ŒÙ‡Ø§: ${
      offs.map(o=>`${o.jdate} (${o.weekday})`).join(' ØŒ ')
    }`;
  } else holBar.style.display='none';

  // Ø±Ø¯ÛŒÙÙ Ù‡Ø± ØªØ§Ø±ÛŒØ® Ú©Ø§Ø±ÛŒ
  ACTIVE_DAYS.forEach((d, idx)=>{
    const options = [
      d.menu["Ø®ÙˆØ±Ø§Ú©"] ? `<option value="${d.menu["Ø®ÙˆØ±Ø§Ú©"]}">${d.menu["Ø®ÙˆØ±Ø§Ú©"]} (Ø®ÙˆØ±Ø§Ú©)</option>` : "",
      d.menu["Ú©Ø¨Ø§Ø¨ÛŒ"] ? `<option value="${d.menu["Ú©Ø¨Ø§Ø¨ÛŒ"]}">${d.menu["Ú©Ø¨Ø§Ø¨ÛŒ"]} (Ú©Ø¨Ø§Ø¨ÛŒ)</option>` : "",
      d.menu["Ø®ÙˆØ±Ø´ØªÛŒ"] ? `<option value="${d.menu["Ø®ÙˆØ±Ø´ØªÛŒ"]}">${d.menu["Ø®ÙˆØ±Ø´ØªÛŒ"]} (Ø®ÙˆØ±Ø´ØªÛŒ)</option>` : ""
    ].join("");

    box.insertAdjacentHTML('beforeend', `
      <div class="grid-day">
        <div class="badge" data-wd="${d.weekday}">${d.jdate} (${d.weekday})</div>
        <select id="meal_${idx}" class="select">${options}</select>
        <select id="side_${idx}" class="select">
          ${SIDES.map(s=>`<option value="${s}">${s}</option>`).join('')}
        </select>
      </div>
    `);
  });
}

// ===== Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ú©Ø§Ø±Ø¨Ø± (Ø¨Ø±Ø§ÛŒ ØªÚ©â€ŒØªÚ© ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§) =====
function submitOrder(){
  const code = localStorage.getItem('currentUser');
  const section = localStorage.getItem('currentUserSection');
  if(!code){ alert('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.'); return; }

  const order = { section, range: MENU.range, days: [] };
  ACTIVE_DAYS.forEach((d, idx)=>{
    const meal = document.getElementById(`meal_${idx}`).value;
    const side = document.getElementById(`side_${idx}`).value;
    order.days.push({ jdate:d.jdate, weekday:d.weekday, meal, side });
  });

  localStorage.setItem(`order_${code}`, JSON.stringify(order));
  document.getElementById('orderMsg').textContent='Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ø´Ø¯ âœ…';
}

// ===== Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±: Ø¬Ø¯ÙˆÙ„ Ùˆ Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§ =====
function populateSectionFilter(){
  const sel = document.getElementById('sectionFilter');
  const secs = [...new Set(users.map(u=>u.section))];
  secs.forEach(s=>{
    const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o);
  });
}
function renderOrdersTable(){
  const tbody=document.querySelector('#ordersTable tbody'); tbody.innerHTML='';
  const filter=document.getElementById('sectionFilter').value;

  users.forEach(u=>{
    const data = JSON.parse(localStorage.getItem(`order_${u.code}`)||'null');
    if(!data || !data.days) return;
    if(filter!=='Ù‡Ù…Ù‡' && (data.section||u.section)!==filter) return;

    // Ø®Ù„Ø§ØµÙ‡Ù” Ù‡ÙØªÚ¯ÛŒÙ Ø¢Ø®Ø±ÛŒÙ† Ø³ÙØ§Ø±Ø´ ÙØ±Ø¯ (Ø¨Ù‡ ØªØ±ØªÛŒØ¨ Ø´Ù†Ø¨Ù‡..Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡)
    const byWd = {};
    data.days.forEach(d=>{ byWd[d.weekday] = `${d.meal} + ${d.side}`; });
    const tds = WD_ORDER.map(wd=>`<td>${byWd[wd]||''}</td>`).join('');

    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${u.code}</td><td>${u.name}</td><td>${data.section||u.section||''}</td>${tds}
    </tr>`);
  });
}

// CSV Ù‡ÙØªÚ¯ÛŒ (Ø®Ù„Ø§ØµÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ù†Ø¨Ù‡..Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡)
function exportWeekCSV(){
  let csv = "Ú©Ø¯ Ù…Ù„ÛŒ,Ù†Ø§Ù…,Ø¨Ø®Ø´,"+WD_ORDER.join(",")+"\n";
  users.forEach(u=>{
    const data=JSON.parse(localStorage.getItem(`order_${u.code}`)||'null');
    if(!data || !data.days) return;
    const byWd={}; data.days.forEach(d=>{ byWd[d.weekday]=`${d.meal} + ${d.side}`; });
    csv += [u.code,u.name,data.section||u.section||'', ...WD_ORDER.map(w=>byWd[w]||'')].join(",")+"\n";
  });
  downloadCSV(csv, "orders_week.csv");
}

// CSV Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø·Ø¨Ù‚Ù‡ (Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±ÙˆØ² Ø§Ø² ACTIVE_DAYS ÛŒÚ© ÙØ§ÛŒÙ„)
function exportDailyByFloorCSV(){
  ACTIVE_DAYS.forEach(d=>{
    const dayKey = d.jdate;
    const floors = [...new Set(users.map(u=>u.section))];
    let any=false, blocks=[];

    floors.forEach(f=>{
      let block = `ØªØ§Ø±ÛŒØ®: ${dayKey} (${d.weekday}) - ${f}\nÚ©Ø¯ Ù…Ù„ÛŒ,Ù†Ø§Ù…,Ø³ÙØ§Ø±Ø´\n`;
      users.forEach(u=>{
        const data=JSON.parse(localStorage.getItem(`order_${u.code}`)||'null');
        if(!data || !data.days) return;
        if(u.section!==f) return;
        const rec = data.days.find(x=>x.jdate===dayKey);
        block += `${u.code},${u.name},${rec?`${rec.meal} + ${rec.side}`:''}\n`;
        any = true;
      });
      blocks.push(block);
    });

    if(any) downloadCSV("\uFEFF"+blocks.join("\n"), `orders_${dayKey}_by_floor.csv`);
  });
}
function downloadCSV(text, filename){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),0);
}

// ===== Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ù†Ùˆ Ø§Ø² menu.json =====
async function loadMenu(){
  try{
    const res = await fetch('./menu.json?v=' + Date.now());
    MENU = await res.json();

    // Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ø²Ù‡
    document.getElementById('rangeTitle').textContent =
      `Ø§Ù†ØªØ®Ø§Ø¨ ØºØ°Ø§ Ùˆ Ú©Ù†Ø§Ø±ØºØ°Ø§ ( ${MENU.range.start} ØªØ§ ${MENU.range.end} Ø´Ù‡Ø±ÛŒÙˆØ± )`;
    document.getElementById('rangeNote').textContent =
      `Ø¨Ø§Ø²Ù‡ ÙØ¹Ø§Ù„: ${MENU.range.start} ØªØ§ ${MENU.range.end}`;

    SIDES = MENU.sides || ["Ù†ÙˆØ´Ø§Ø¨Ù‡","Ø¯ÙˆØº","Ø³Ø§Ù„Ø§Ø¯ ÙØµÙ„","Ù…Ø§Ø³Øª"];
    // ÙÙ‚Ø· Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±ÛŒ Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ (off=false)
    ACTIVE_DAYS = (MENU.days||[]).filter(d=>!d.off);

    if(ACTIVE_DAYS.length){
      document.getElementById('menuStatus').innerHTML = '<span class="okdot">â—</span> Ù…Ù†Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯';
    }else{
      document.getElementById('menuStatus').textContent = 'Ù…Ù†ÙˆÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.';
    }
  }catch(e){
    document.getElementById('menuStatus').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ù†Ùˆ';
  }
}
loadMenu();
</script>
</body>
</html>
